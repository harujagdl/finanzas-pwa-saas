<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mi Control Financiero</title>

  <!-- ‚úÖ PWA -->
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Finanzas Yayos" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icons/icon-192.png" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-body:#f3f4f6; --bg-card:#ffffff; --text-main:#1f2937; --text-muted:#6b7280;
      --primary:#2563eb; --danger:#ef4444; --success:#10b981; --warning:#f59e0b;
      --shadow:0 4px 6px -1px rgba(0,0,0,.05); --border-color:#e5e7eb;
      --sheet-overlay:rgba(15,23,42,.35);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg-body:#111827; --bg-card:#1f2937; --text-main:#f9fafb; --text-muted:#9ca3af;
        --shadow:0 4px 6px -1px rgba(0,0,0,.3); --border-color:#374151;
        --sheet-overlay:rgba(2,6,23,.6);
      }
    }
    html.theme-dark{
      --bg-body:#111827; --bg-card:#1f2937; --text-main:#f9fafb; --text-muted:#9ca3af;
      --shadow:0 4px 6px -1px rgba(0,0,0,.3); --border-color:#374151;
      --sheet-overlay:rgba(2,6,23,.6);
    }
    html.theme-light{
      --bg-body:#f3f4f6; --bg-card:#ffffff; --text-main:#1f2937; --text-muted:#6b7280;
      --shadow:0 4px 6px -1px rgba(0,0,0,.05); --border-color:#e5e7eb;
      --sheet-overlay:rgba(15,23,42,.35);
    }
    body{
      background:var(--bg-body); color:var(--text-main); font-family:'Inter',sans-serif;
      padding-bottom:110px; transition:background .3s; -webkit-tap-highlight-color:transparent;
    }
    .text-muted{color:var(--text-muted)!important;} .text-dark{color:var(--text-main)!important;}
    h1,h2,h3,h4,h5,h6{color:var(--text-main);}
    .card-box{
      background:var(--bg-card); border-radius:16px; padding:20px; margin-bottom:16px;
      box-shadow:var(--shadow); border:none; transition:background .3s;
    }
    .fw-black{font-weight:800;}
    .blur-sensitive{filter:blur(6px); user-select:none; transition:filter .3s;}
    .kpi-label{font-size:.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); font-weight:700;}
    .kpi-value{font-size:1.75rem; font-weight:800; letter-spacing:-1px;}
    .smart-banner{
      background:linear-gradient(135deg,var(--primary),#1e40af); color:#fff; border-radius:16px;
      padding:20px; margin-bottom:24px; box-shadow:0 10px 15px -3px rgba(37,99,235,.3);
    }
    .list-item{
      background:var(--bg-card); padding:16px; border-radius:12px; margin-bottom:10px;
      display:flex; justify-content:space-between; align-items:center;
      border:1px solid var(--border-color);
    }
    .badge-status{padding:4px 8px; border-radius:6px; font-size:.7rem; font-weight:700; text-transform:uppercase;}
    .bg-danger-light{background:rgba(239,68,68,.15); color:var(--danger);}
    .bg-success-light{background:rgba(16,185,129,.15); color:var(--success);}
    .bg-warning-light{background:rgba(245,158,11,.15); color:var(--warning);}
    .net-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px; border-radius:999px;
      font-size:.7rem; font-weight:800; text-transform:uppercase;
      border:1px solid var(--border-color);
      background:var(--bg-body); color:var(--text-muted);
    }
    .net-badge.offline{background:rgba(239,68,68,.12); color:var(--danger); border-color:rgba(239,68,68,.3);}
    .net-badge.online{background:rgba(16,185,129,.12); color:var(--success); border-color:rgba(16,185,129,.3);}
    .sync-pill{padding:4px 8px; border-radius:999px; font-size:.7rem; font-weight:800; text-transform:uppercase;}
    .sync-pill.syncing{background:rgba(245,158,11,.15); color:var(--warning);}
    .sync-pill.synced{background:rgba(16,185,129,.15); color:var(--success);}
    .sync-pill.local{background:rgba(107,114,128,.15); color:var(--text-muted);}
    #toast-container{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:90px; z-index:1500; display:flex; flex-direction:column; gap:8px;
      max-width:90vw; pointer-events:none;
    }
    .toast-message{
      background:var(--bg-card); color:var(--text-main);
      border:1px solid var(--border-color);
      border-radius:12px; padding:10px 14px; font-size:.85rem;
      box-shadow:var(--shadow);
      opacity:0; transform:translateY(8px);
      transition:opacity .2s ease, transform .2s ease;
    }
    .toast-message.toast-show{opacity:1; transform:translateY(0);}
    .toast-message.toast-hide{opacity:0; transform:translateY(6px);}
    .toast-message.success{border-color:rgba(16,185,129,.4);}
    .toast-message.warning{border-color:rgba(245,158,11,.4);}
    .toast-message.info{border-color:rgba(107,114,128,.4);}
    .fade-in{opacity:0; transform:translateY(6px); transition:opacity .2s ease, transform .2s ease;}
    .fade-in.is-visible{opacity:1; transform:translateY(0);}
    .is-loading{opacity:.7; pointer-events:none;}
    .missing-index-banner{
      border:1px solid rgba(245,158,11,.3);
      background:rgba(245,158,11,.12);
      color:var(--text-main);
    }
    .missing-index-banner .banner-title{font-weight:700;}
    .missing-index-banner .banner-link{color:inherit; font-weight:600;}
    .btn-loading{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn-loading .spinner{
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,.45); border-top-color:#fff;
      animation:spin .6s linear infinite;
    }
    .btn-success-flash{
      background:var(--success)!important; border-color:var(--success)!important;
    }
    .btn-success-flash .checkmark{
      width:18px; height:18px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.2); font-weight:800;
    }
    .skeleton{
      position:relative; overflow:hidden; background:var(--bg-body);
      border-radius:10px;
    }
    .skeleton::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform:translateX(-100%); animation:shimmer 1.2s ease-in-out infinite;
    }
    .skeleton-line{height:12px; margin:8px 0; border-radius:999px;}
    .skeleton-line.tall{height:22px;}
    .skeleton-card{padding:12px; border-radius:12px; border:1px solid var(--border-color);}
    .skeleton-grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));}
    .chart-skeleton{
      width:100%; height:100%;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; text-align:center;
    }
    .chart-skeleton .skeleton-pie{width:120px; height:120px; border-radius:50%;}
    .chart-skeleton .skeleton-text{width:140px; height:12px;}
    .chart-message{font-size:.85rem; text-align:center;}
    @keyframes spin{to{transform:rotate(360deg);}}
    @keyframes shimmer{to{transform:translateX(100%);}}

    .nav-bottom{
      position:fixed; bottom:0; width:100%;
      background:var(--bg-card);
      display:grid; grid-template-columns:repeat(6, 1fr);
      padding:10px 0; border-top:1px solid var(--border-color);
      z-index:100; padding-bottom:max(10px, env(safe-area-inset-bottom));
    }
    .nav-container-item{display:flex; justify-content:center; align-items:center; position:relative; height:100%;}
    .nav-btn{
      background:none; border:none; color:var(--text-muted);
      font-size:.7rem; font-weight:600;
      display:flex; flex-direction:column; align-items:center; width:100%;
    }
    .nav-btn i{font-size:1.35rem; margin-bottom:4px;}
    .nav-btn.active{color:var(--primary);}
    .nav-emoji{
      font-size:1.35rem;
      line-height:1;
      margin-bottom:4px;
    }
    .trophy-icon{color:#f5c542;}

    .fab-main{
      background:var(--primary); color:#fff; width:56px; height:56px; border-radius:50%;
      display:flex; justify-content:center; align-items:center;
      position:relative; transform:translateY(-15px);
      border:5px solid var(--bg-body);
      box-shadow:0 4px 12px rgba(37,99,235,.4);
      font-size:1.5rem; transition:border-color .3s, transform .1s; z-index:101; cursor:pointer;
    }
    .fab-main:active{transform:translateY(-12px) scale(.95);}
    .quick-fab{
      position:fixed; right:18px; bottom:92px;
      width:56px; height:56px; border-radius:50%;
      background:var(--primary); color:#fff; border:none;
      box-shadow:0 8px 20px rgba(37,99,235,.4);
      display:flex; align-items:center; justify-content:center;
      z-index:120; font-size:1.4rem;
    }
    .quick-fab:active{transform:scale(.96);}
    .quick-sheet-backdrop{
      position:fixed; inset:0; background:var(--sheet-overlay);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:110;
    }
    .quick-sheet-backdrop.is-open{opacity:1; pointer-events:auto;}
    .quick-sheet{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--bg-card); border-top-left-radius:18px; border-top-right-radius:18px;
      padding:18px; transform:translateY(120%); transition:transform .2s ease;
      z-index:120; border:1px solid var(--border-color);
      box-shadow:0 -10px 30px rgba(15,23,42,.15);
    }
    .quick-sheet.is-open{transform:translateY(0);}
    .quick-sheet-handle{
      width:48px; height:5px; background:var(--border-color);
      border-radius:999px; margin:0 auto 12px;
    }
    .quick-sheet-title{font-weight:800; margin-bottom:10px;}
    .quick-sheet-actions{display:flex; gap:10px; margin-top:12px;}
    .quick-sheet-actions .btn{flex:1;}
    .swipe-item{
      touch-action:pan-y;
      transition:transform .2s ease;
      will-change:transform;
    }
    .swipe-item.dragging{transition:none;}
    .swipe-item.reviewed{
      border-color:rgba(16,185,129,.4);
      background:rgba(16,185,129,.08);
    }
    .item-actions{position:relative;}
    .action-kebab{
      border:1px solid var(--border-color);
      background:var(--bg-body); color:var(--text-muted);
      width:32px; height:32px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
    }
    .action-menu{
      position:absolute; right:0; top:38px;
      background:var(--bg-card); border:1px solid var(--border-color);
      border-radius:12px; padding:6px; min-width:160px;
      box-shadow:var(--shadow); display:none; z-index:130;
    }
    .action-menu button{
      width:100%; border:none; background:none; text-align:left;
      padding:6px 8px; border-radius:8px; color:var(--text-main); font-size:.85rem;
    }
    .action-menu button:hover{background:var(--bg-body);}
    .action-menu.is-open{display:block;}

    .form-control,.form-select{
      background:var(--bg-body); border:1px solid var(--border-color);
      color:var(--text-main); padding:12px; border-radius:10px;
    }
    .form-control:focus,.form-select:focus{
      background:var(--bg-card); border-color:var(--primary);
      box-shadow:none; color:var(--text-main);
    }
    .form-control:focus-visible,.form-select:focus-visible,.btn:focus-visible{
      outline:2px solid rgba(37,99,235,.5); outline-offset:2px;
    }
    .btn-disabled{background:#6b7280!important; border-color:#6b7280!important; cursor:not-allowed; opacity:.7;}

    .view-section{display:none; animation:fadeIn .2s ease-out;}
    .view-section.active{display:block;}
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);}}

    #loader{
      position:fixed; inset:0; background:var(--bg-card); z-index:2000;
      display:flex; justify-content:center; align-items:center; flex-direction:column;
    }
    .loader-error{
      margin-top:16px; padding:12px 14px; border-radius:12px;
      border:1px solid var(--border-color); background:var(--bg-body);
      max-width:320px; text-align:center;
    }
    .loader-error p{margin:0 0 10px; font-size:.9rem; color:var(--text-muted);}
    .owner-select{width:120px; padding:8px 10px; border-radius:12px; font-weight:800;}

    /* MSI */
    .msi-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid var(--border-color);
      background:var(--bg-body);
      font-weight:800; font-size:.8rem;
    }
    .alert-item{
      display:flex; gap:12px; align-items:flex-start;
      background:var(--bg-card); border:1px solid var(--border-color);
      border-radius:12px; padding:12px 14px; margin-bottom:10px;
    }
    .alert-content{flex:1;}
    .alert-actions{margin-left:auto; display:flex; align-items:flex-start;}
    .alert-icon{
      font-size:1.1rem; line-height:1; margin-top:2px;
    }
    .dashboard-grid{
      display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    }
    .dash-card{
      background:var(--bg-body); border:1px solid var(--border-color);
      border-radius:14px; padding:14px;
    }
    .dash-title{
      font-size:.75rem; text-transform:uppercase; letter-spacing:.8px;
      color:var(--text-muted); font-weight:700;
    }
    .dash-total{font-size:1.5rem; font-weight:800; letter-spacing:-0.5px;}
    .dash-compare{font-size:.85rem; display:flex; gap:6px; align-items:center;}
    .trend-good{color:var(--success);}
    .trend-warn{color:var(--warning);}
    .trend-neutral{color:var(--text-muted);}
    .insight-item{
      display:flex; gap:12px; align-items:flex-start;
      background:var(--bg-card); border:1px solid var(--border-color);
      border-radius:12px; padding:12px 14px; margin-bottom:10px;
    }
    .insight-icon{font-size:1.1rem; line-height:1; margin-top:2px;}
    .insight-title{font-weight:700;}
    .bg-neutral-light{background:rgba(107,114,128,.15); color:var(--text-muted);}
    .timeline-day{margin-bottom:16px;}
    .timeline-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px; padding-bottom:6px; border-bottom:1px dashed var(--border-color);
    }
    .timeline-title{font-weight:800;}
    .timeline-subtotal{font-size:.85rem; color:var(--text-muted);}
    .timeline-items .list-item{margin-bottom:8px;}
    .simulation-box{
      background:var(--bg-body); border:1px dashed var(--border-color);
      border-radius:14px; padding:12px;
    }
    .simulation-result{
      background:var(--bg-card); border:1px solid var(--border-color);
      border-radius:12px; padding:12px; margin-top:12px;
    }
    .simulation-result.sim-active{border-color:rgba(37,99,235,.3);}
    .simulation-label{
      font-size:.75rem; text-transform:uppercase; letter-spacing:.8px;
      color:var(--text-muted); font-weight:700;
    }
    .simulation-value{font-weight:800;}
    .goals-header{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;
    }
    .goal-card{
      background:var(--bg-card); border:1px solid var(--border-color);
      border-radius:14px; padding:14px; margin-bottom:12px;
    }
    .goal-metrics{display:flex; flex-wrap:wrap; gap:8px; font-size:.82rem; color:var(--text-muted);}
    .goal-actions{display:flex; gap:8px; flex-wrap:wrap;}
    .goal-actions .btn{flex:1;}
    .goal-detail-meta{display:flex; flex-wrap:wrap; gap:12px; font-size:.85rem; color:var(--text-muted);}
    .goal-contrib-item{
      border:1px solid var(--border-color); border-radius:12px; padding:10px 12px;
      background:var(--bg-body);
    }
    .goal-card.dragging{
      box-shadow:0 12px 24px rgba(15,23,42,.15);
      border-color:rgba(37,99,235,.4);
    }
    .goal-placeholder{
      border:2px dashed var(--border-color);
      border-radius:14px;
      margin-bottom:12px;
      background:transparent;
    }
    .goal-handle{
      cursor:grab; display:inline-flex; align-items:center; justify-content:center;
      width:32px; height:32px; border-radius:8px;
      border:1px dashed var(--border-color); color:var(--text-muted);
      touch-action:none;
    }
    .goal-handle:active{cursor:grabbing;}
    .goal-move-btn{
      border:1px solid var(--border-color); background:var(--bg-body);
      color:var(--text-muted); width:28px; height:28px; border-radius:8px;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .goal-move-controls{display:none; gap:6px;}
    body.ios-fallback .goal-move-controls{display:inline-flex;}
    @media (prefers-reduced-motion: reduce){
      .fade-in, .toast-message{transition:none;}
      .btn-loading .spinner, .skeleton::after{animation:none;}
      .view-section{animation:none;}
      .quick-sheet, .quick-sheet-backdrop, .swipe-item{transition:none;}
    }
  </style>
</head>

<body>
  <div id="loader">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-3 fw-bold small text-muted">Cargando Sistema...</div>
    <div class="mt-2 small text-muted" id="loader-msg">Conectando a Firestore...</div>
    <div class="mt-1 small text-muted" id="connection-status"></div>
    <div id="loader-error" class="loader-error d-none">
      <p id="loader-error-msg">No se pudo conectar. Revisa tu internet y vuelve a intentar.</p>
      <button class="btn btn-outline-primary btn-sm" id="loader-retry" type="button">Reintentar</button>
    </div>
  </div>

  <!-- =======================
        ‚úÖ INICIO
  ======================= -->
  <div id="view-home" class="view-section active p-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h5 class="fw-black m-0">Control Total</h5>
        <div class="d-flex align-items-center gap-2 flex-wrap mt-1">
          <div id="netBadge" class="net-badge offline">Offline</div>
          <span id="sync-status" class="sync-pill synced">Sincronizado</span>
          <small id="sync-time" class="text-muted small d-none">√öltima sincronizaci√≥n: --</small>
        </div>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <select id="owner-select" class="form-select form-select-sm owner-select" title="¬øQui√©n est√° usando la app?">
          <option value="yair">Yair</option>
          <option value="haru">Haru</option>
        </select>

        <!-- üîî Push (por ahora solo placeholder) -->
        <button class="btn btn-sm btn-outline-secondary rounded-circle"
          onclick="enablePush()"
          title="Activar recordatorios"
          style="width:40px;height:40px;border-color:var(--border-color);color:var(--text-main);">
          <i class="fas fa-bell"></i>
        </button>

        <button class="btn btn-sm btn-outline-secondary rounded-circle"
          onclick="manualRefresh()"
          title="Actualizar datos"
          style="width:40px;height:40px;border-color:var(--border-color);color:var(--text-main);">
          <i class="fas fa-rotate"></i>
        </button>

        <button class="btn btn-sm btn-outline-secondary rounded-circle"
          onclick="toggleThemeMode()"
          title="Cambiar tema"
          style="width:40px;height:40px;border-color:var(--border-color);color:var(--text-main);">
          <i class="fas fa-moon" id="theme-icon"></i>
        </button>

        <button class="btn btn-sm btn-outline-secondary rounded-circle"
          onclick="togglePrivacy()"
          style="width:40px;height:40px;border-color:var(--border-color);color:var(--text-main);">
          <i class="fas fa-eye" id="eye-icon"></i>
        </button>
      </div>
    </div>

    <div id="smart-area" class="d-none">
      <div class="smart-banner">
        <div class="d-flex align-items-center mb-2" style="opacity:.9;">
          <i class="fas fa-magic me-2"></i> RECOMENDACI√ìN DEL D√çA
        </div>
        <h2 class="fw-black mb-1" id="smart-name">...</h2>
        <p class="mb-0 small" id="smart-msg" style="opacity:.9;">...</p>
      </div>
    </div>

    <div id="missing-index-banner" class="card-box missing-index-banner d-none">
      <div class="d-flex align-items-start gap-2">
        <div class="banner-title">‚ö†Ô∏è Falta un √≠ndice de Firestore para cargar res√∫menes.</div>
      </div>
      <div class="small mt-2">
        Abre consola para el link o ve a Firestore ‚Üí √çndices y crea owner+type+date.
        <a id="missing-index-link" class="banner-link ms-1 d-none" target="_blank" rel="noopener noreferrer">Abrir √≠ndice</a>
      </div>
    </div>

    <section id="scope-filter-section" class="card-box p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="kpi-label">Filtro de gastos</div>
        <span class="text-muted small" id="scope-filter-label">Todo</span>
      </div>
      <div class="btn-group w-100" role="group" aria-label="Filtro de gastos">
        <input type="radio" class="btn-check" name="scope-filter" id="scope-filter-all" value="all" onchange="handleScopeFilterChange(this.value)">
        <label class="btn btn-outline-secondary" for="scope-filter-all">Todo</label>
        <input type="radio" class="btn-check" name="scope-filter" id="scope-filter-shared" value="shared" onchange="handleScopeFilterChange(this.value)">
        <label class="btn btn-outline-secondary" for="scope-filter-shared">Compartido</label>
        <input type="radio" class="btn-check" name="scope-filter" id="scope-filter-personal" value="personal" onchange="handleScopeFilterChange(this.value)">
        <label class="btn btn-outline-secondary" for="scope-filter-personal">Personal</label>
      </div>
    </section>

    <section id="dashboard-summary" class="card-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold m-0"><i class="fas fa-gauge-high me-2"></i>Resumen</h6>
      </div>
      <div id="dashboard-summary-body" class="text-muted small">Cargando resumen...</div>
    </section>

    <section id="prediction-section" class="card-box">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold m-0"><i class="fas fa-chart-line me-2"></i>Predicci√≥n del mes</h6>
        <span id="prediction-status" class="badge-status bg-neutral-light">Sin datos</span>
      </div>
      <div id="prediction-body" class="text-muted small">Calculando predicci√≥n...</div>
    </section>

    <section id="simulation-section" class="card-box">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold m-0"><i class="fas fa-vial me-2"></i>Simular gasto</h6>
        <span id="simulation-status" class="badge-status bg-warning-light d-none">SIMULADO</span>
      </div>
      <div class="simulation-box">
        <div class="row g-2">
          <div class="col-7">
            <label class="small fw-bold text-muted mb-1">Monto</label>
            <input type="number" id="sim-amount" class="form-control" placeholder="0.00" step="0.01" />
          </div>
          <div class="col-5">
            <label class="small fw-bold text-muted mb-1">Categor√≠a (opcional)</label>
            <input type="text" id="sim-category" class="form-control" placeholder="Ej: Comida" />
          </div>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-primary flex-fill" type="button" onclick="runSimulation()">Simular</button>
          <button class="btn btn-light flex-fill" type="button" onclick="cancelSimulation()">Cancelar</button>
        </div>
        <div id="simulation-result" class="simulation-result d-none"></div>
      </div>
    </section>

    <div id="alerts-section" class="card-box d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold m-0"><i class="fas fa-triangle-exclamation me-2 text-danger"></i>Alertas</h6>
        <span class="badge-status bg-danger-light">0-2 d√≠as</span>
      </div>
      <div id="alerts-list"><small class="text-muted">Sin alertas por ahora.</small></div>
    </div>

    <section id="insights-section" class="card-box d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold m-0"><i class="fas fa-lightbulb me-2 text-warning"></i>Insights</h6>
      </div>
      <div id="insights-list"><small class="text-muted">Cargando insights...</small></div>
    </section>

    <section id="monthly-footprint-section" class="card-box d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <h6 class="fw-bold m-0"><i class="fas fa-leaf me-2"></i>Huella mensual</h6>
          <div class="text-muted small" id="monthly-footprint-period">Cierre del mes anterior</div>
        </div>
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="manualCloseMonth()">Cerrar mes</button>
      </div>
      <div id="monthly-footprint-body" class="text-muted small">Generando resumen...</div>
    </section>

    <div class="card-box mb-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold m-0"><i class="fas fa-clipboard-check me-2"></i>Monitor de Pagos (Mes Actual)</h6>
        <span class="msi-pill" onclick="nav('view-msi')" style="cursor:pointer;">
          <i class="fas fa-layer-group"></i> MSI
        </span>
      </div>
      <div id="payment-monitor-list"><small class="text-muted">Cargando pagos...</small></div>
    </div>

    <div class="card-box p-3 mb-3">
      <div class="d-flex justify-content-between mb-2">
        <span class="kpi-label">Nivel de Endeudamiento</span>
        <span class="fw-bold small sensitive-data" id="util-text">0%</span>
      </div>
      <div class="progress" style="height:10px;background-color:var(--bg-body);">
        <div id="util-bar" class="progress-bar" role="progressbar" style="width:0%"></div>
      </div>
      <small class="text-muted d-block mt-2" style="font-size:.75rem;" id="util-msg">Calculando...</small>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-6">
        <div class="card-box p-3">
          <div class="kpi-label">Deuda Total</div>
          <div class="kpi-value text-danger sensitive-data" id="total-debt">$0</div>
        </div>
      </div>
      <div class="col-6">
        <div class="card-box p-3">
          <div class="kpi-label">Disponible</div>
          <div class="kpi-value text-success sensitive-data" id="total-avail">$0</div>
        </div>
      </div>
    </div>

    <div class="card-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold m-0">Distribuci√≥n de Gastos</h6>
        <select id="chart-month-filter" class="form-select form-select-sm w-auto py-1" onchange="updateChart()"></select>
      </div>
      <div style="position:relative;height:200px;display:flex;justify-content:center;align-items:center;" id="chart-container">
        <canvas id="expensesChart"></canvas>
        <div id="chart-skeleton" class="chart-skeleton d-none">
          <div class="skeleton skeleton-pie"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="text-muted small">Cargando gr√°fica...</div>
        </div>
        <div id="no-data-msg" class="text-muted chart-message d-none">A√∫n no hay gastos para graficar este mes.</div>
        <div id="chart-error-msg" class="text-danger chart-message d-none">No se pudo renderizar la gr√°fica. Reintenta.</div>
      </div>
    </div>

    <h6 class="fw-bold text-muted mb-3 mt-4">ESTADO DE TARJETAS</h6>
    <div id="home-card-list"></div>
  </div>

  <!-- =======================
        ‚úÖ TARJETAS
  ======================= -->
  <div id="view-cards" class="view-section p-3">
    <h4 class="fw-black mb-4">Mis Tarjetas</h4>
    <div class="text-muted small mb-2">* Ya est√°n precargadas. Aqu√≠ solo editas corte/pago/l√≠mite/deuda/meta.</div>
    <div id="manage-card-list"></div>
    <button class="btn btn-primary w-100 py-3 rounded-4 fw-bold shadow mt-3" onclick="openCardModal()">
      <i class="fas fa-pen me-2"></i> Editar Tarjeta
    </button>
  </div>

  <!-- =======================
        ‚úÖ AGREGAR MOV
  ======================= -->
  <div id="view-add" class="view-section p-3">
    <h4 class="fw-black mb-4">Registrar Movimiento</h4>
    <div class="card-box">
      <form id="form-trans">
        <input type="hidden" id="trans-id" />

        <div class="btn-group w-100 mb-4 p-1 rounded-3" role="group" style="background-color:var(--bg-body);">
          <input type="radio" class="btn-check" name="ttype" id="t-exp" value="expense" checked onchange="uiUpdateCats(); uiToggleMsi(); uiToggleScope();" />
          <label class="btn btn-outline-danger border-0 rounded-3" for="t-exp">Gasto (-)</label>
          <input type="radio" class="btn-check" name="ttype" id="t-pay" value="payment" onchange="uiUpdateCats(); uiToggleMsi(); uiToggleScope();" />
          <label class="btn btn-outline-success border-0 rounded-3" for="t-pay">Abono (+)</label>
        </div>

        <div class="mb-3">
          <label class="small fw-bold text-muted mb-1">Monto</label>
          <input type="number" id="t-amount" class="form-control fw-bold" style="font-size:1.5rem;" placeholder="0.00" step="0.01" required />
        </div>

        <div class="mb-3">
          <label class="small fw-bold text-muted mb-1">Tarjeta / Cuenta</label>
          <select id="t-card" class="form-select" required></select>
        </div>

        <div class="mb-3">
          <label class="small fw-bold text-muted mb-1">Categor√≠a</label>
          <select id="t-cat" class="form-select"></select>
        </div>

        <div class="mb-3" id="scope-field">
          <label class="small fw-bold text-muted mb-1">Compartido o personal</label>
          <div class="btn-group w-100 p-1 rounded-3" role="group" style="background-color:var(--bg-body);">
            <input type="radio" class="btn-check" name="tscope" id="t-scope-shared" value="shared" checked />
            <label class="btn btn-outline-secondary border-0 rounded-3" for="t-scope-shared">Compartido</label>
            <input type="radio" class="btn-check" name="tscope" id="t-scope-personal" value="personal" />
            <label class="btn btn-outline-secondary border-0 rounded-3" for="t-scope-personal">Personal</label>
          </div>
          <div class="text-muted small mt-1">* Por defecto es compartido para no friccionar.</div>
        </div>

        <div class="mb-3">
          <label class="small fw-bold text-muted mb-1">Concepto</label>
          <input type="text" id="t-concept" class="form-control" placeholder="Ej: Supermercado" required />
        </div>

        <div class="mb-3">
          <label class="small fw-bold text-muted mb-1">Fecha</label>
          <input type="date" id="t-date" class="form-control" required />
        </div>

        <!-- ‚úÖ MSI -->
        <div id="msi-box" class="mb-4 p-3 rounded-3" style="background-color:var(--bg-body);border:1px dashed var(--border-color); display:none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold"><i class="fas fa-layer-group me-2"></i>Compra a MSI</div>
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" id="t-msi" onchange="uiToggleMsiFields()">
            </div>
          </div>

          <div id="msi-fields" style="display:none;">
            <div class="row g-2">
              <div class="col-6">
                <label class="small fw-bold text-muted mb-1">Meses</label>
                <select id="t-msi-months" class="form-select">
                  <option value="3">3</option>
                  <option value="6" selected>6</option>
                  <option value="9">9</option>
                  <option value="12">12</option>
                  <option value="18">18</option>
                  <option value="24">24</option>
                </select>
              </div>
              <div class="col-6">
                <label class="small fw-bold text-muted mb-1">Inicio MSI</label>
                <input type="date" id="t-msi-start" class="form-control">
              </div>
            </div>

            <div class="mt-3 d-flex justify-content-between align-items-center">
              <small class="text-muted">Mensualidad estimada</small>
              <div class="fw-black sensitive-data" id="msi-monthly">$0.00</div>
            </div>
            <small class="text-muted d-block mt-1" style="font-size:.75rem;">
              * Esto es para ‚Äúsaber cu√°ndo se libera‚Äù. No calcula intereses (MSI real suele ser sin intereses).
            </small>
          </div>
        </div>

        <button type="submit" id="btn-save-trans" class="btn btn-primary w-100 py-3 rounded-3 fw-bold shadow-sm">Guardar Transacci√≥n</button>

        <div id="edit-btns" class="row g-2 mt-3" style="display:none;">
          <div class="col-6">
            <button type="button" class="btn btn-outline-danger w-100" onclick="deleteTrans()">Eliminar</button>
          </div>
          <div class="col-6">
            <button type="button" class="btn btn-light w-100" onclick="resetForm()">Cancelar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- =======================
        ‚úÖ HISTORIAL
  ======================= -->
  <div id="view-hist" class="view-section p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="fw-black m-0">Historial</h4>
      <button class="btn btn-sm btn-outline-secondary" style="border-color:var(--border-color);color:var(--text-muted);" onclick="exportCSV()">
        <i class="fas fa-file-csv me-1"></i> CSV
      </button>
    </div>

    <div class="row g-2 mb-3">
      <div class="col-6">
        <select id="hist-month-filter" class="form-select" onchange="renderHistory()">
          <option value="all">Mes: Todo</option>
        </select>
      </div>
      <div class="col-6">
        <select id="hist-card-filter" class="form-select" onchange="renderHistory()">
          <option value="all">Tarjeta: Todas</option>
        </select>
      </div>

      <div class="col-6">
        <select id="hist-cat-filter" class="form-select" onchange="renderHistory()">
          <option value="all">Categor√≠a: Todas</option>
        </select>
      </div>

      <div class="col-6">
        <input type="text" id="search-input" class="form-control" placeholder="üîç Buscar..." onkeyup="renderHistory()" />
      </div>

      <div class="col-12 d-grid">
        <button class="btn btn-light" style="border:1px solid var(--border-color);" onclick="clearHistFilters()">
          <i class="fas fa-eraser me-2"></i> Limpiar filtros
        </button>
      </div>
    </div>

    <div id="hist-list"></div>
  </div>

  <!-- =======================
        ‚úÖ METAS
  ======================= -->
  <div id="view-goals" class="view-section p-3">
    <div class="goals-header">
      <div>
        <h4 class="fw-black m-0">Metas</h4>
        <div class="text-muted small">Prioriza y ordena tus metas activas.</div>
      </div>
      <button class="btn btn-sm btn-outline-secondary" style="border-color:var(--border-color);color:var(--text-muted);" onclick="openGoalModal()">
        <i class="fas fa-plus me-1"></i> Nueva meta
      </button>
    </div>
    <div id="missing-index-goals-banner" class="card-box missing-index-banner d-none">
      <div class="d-flex align-items-start gap-2">
        <div class="banner-title">‚ö†Ô∏è Falta un √≠ndice de Firestore para cargar Metas.</div>
      </div>
      <div class="small mt-2">
        No se pudieron cargar metas por √≠ndice faltante.
        <a id="missing-index-goals-link" class="banner-link ms-1 d-none" target="_blank" rel="noopener noreferrer">Abrir √≠ndice</a>
      </div>
      <div class="d-flex flex-wrap gap-2 mt-3">
        <button id="missing-index-goals-retry" class="btn btn-sm btn-warning" type="button" onclick="retryGoalsSubscription()">
          Reintentar
        </button>
      </div>
      <div id="missing-index-goals-debug" class="small text-muted mt-2"></div>
    </div>
    <div id="goals-list"><small class="text-muted">Cargando...</small></div>
  </div>

  <!-- =======================
        ‚úÖ MSI (NUEVO)
  ======================= -->
  <div id="view-msi" class="view-section p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="fw-black m-0">MSI</h4>
        <div class="text-muted small">Compras a meses y cu√°nto falta para que ‚Äúse liberen‚Äù.</div>
      </div>
      <button class="btn btn-sm btn-outline-secondary" style="border-color:var(--border-color);color:var(--text-muted);" onclick="nav('view-home')">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </button>
    </div>

    <div class="card-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold m-0">Meses restantes por compra</h6>
        <select id="msi-filter" class="form-select form-select-sm w-auto py-1" onchange="renderMsi()">
          <option value="active">Activas</option>
          <option value="all">Todas</option>
          <option value="done">Liquidadas</option>
        </select>
      </div>
      <div style="position:relative;height:260px;">
        <canvas id="msiChart"></canvas>
        <div id="msi-no-data" class="text-muted small d-none" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
          No hay compras MSI registradas.
        </div>
      </div>
    </div>

    <div class="card-box">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold m-0">Detalle</h6>
        <span class="text-muted small" id="msi-count">0</span>
      </div>
      <div id="msi-list"><small class="text-muted">Cargando...</small></div>
    </div>
  </div>

  <button class="quick-fab" type="button" onclick="openQuickAdd()" aria-label="Agregar gasto r√°pido">
    <i class="fas fa-plus"></i>
  </button>
  <div id="quick-sheet-backdrop" class="quick-sheet-backdrop" onclick="closeQuickAdd()"></div>
  <div id="quick-sheet" class="quick-sheet" role="dialog" aria-modal="true" aria-labelledby="quick-sheet-title">
    <div class="quick-sheet-handle"></div>
    <div class="quick-sheet-title" id="quick-sheet-title">Agregar gasto r√°pido</div>
    <div class="row g-2">
      <div class="col-6">
        <label class="small fw-bold text-muted mb-1">Monto</label>
        <input type="number" id="quick-amount" class="form-control fw-bold" placeholder="0.00" step="0.01" />
      </div>
      <div class="col-6">
        <label class="small fw-bold text-muted mb-1">Categor√≠a</label>
        <select id="quick-category" class="form-select"></select>
      </div>
    </div>
    <div class="quick-sheet-actions">
      <button class="btn btn-light" type="button" onclick="closeQuickAdd()">Cancelar</button>
      <button class="btn btn-primary" type="button" onclick="saveQuickAdd()">Guardar</button>
    </div>
  </div>

  <!-- =======================
        ‚úÖ NAV
  ======================= -->
  <div class="nav-bottom">
    <div class="nav-container-item">
      <button class="nav-btn active" onclick="nav('view-home')" id="nav-home"><i class="fas fa-chart-pie"></i> Inicio</button>
    </div>
    <div class="nav-container-item">
      <button class="nav-btn" onclick="nav('view-cards')" id="nav-cards"><i class="fas fa-wallet"></i> Tarjetas</button>
    </div>
    <div class="nav-container-item">
      <div class="fab-main" onclick="nav('view-add'); resetForm();"><i class="fas fa-plus"></i></div>
    </div>
    <div class="nav-container-item">
      <button class="nav-btn" onclick="nav('view-msi')" id="nav-msi"><i class="fas fa-layer-group"></i> MSI</button>
    </div>
    <div class="nav-container-item">
      <button class="nav-btn" onclick="nav('view-hist')" id="nav-hist"><i class="fas fa-list-ul"></i> Historial</button>
    </div>
    <div class="nav-container-item">
      <button class="nav-btn" onclick="nav('view-goals')" id="nav-goals">
        <span class="nav-emoji trophy-icon">üèÜ</span> Metas
      </button>
    </div>
  </div>

  <!-- =======================
        ‚úÖ MODAL TARJETA
  ======================= -->
  <div class="modal fade" id="modalCard" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-box border-0">
        <div class="modal-body">
          <h5 class="fw-black mb-3">Editar Tarjeta</h5>
          <div class="text-muted small mb-2">* Selecciona una tarjeta en la lista y ed√≠tala.</div>

          <form id="form-card">
            <input type="hidden" id="c-id" />
            <div class="mb-3">
              <label class="small text-muted fw-bold">Nombre</label>
              <input type="text" id="c-name" class="form-control" placeholder="Ej: Visa Gold" required />
            </div>

            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="small text-muted fw-bold">D√≠a Corte</label>
                <input type="number" id="c-cut" class="form-control" placeholder="1-31" required />
              </div>
              <div class="col-6">
                <label class="small text-muted fw-bold">D√≠a Pago</label>
                <input type="number" id="c-pay" class="form-control" placeholder="1-31" required />
              </div>
            </div>

            <div class="mb-3 p-3 rounded-3" style="background-color:var(--bg-body);border:1px dashed var(--border-color);">
              <label class="small text-danger fw-bold">Pago para no generar intereses</label>
              <input type="number" id="c-goal" class="form-control mt-1" value="0" />
            </div>

            <div class="mb-3">
              <label class="small text-muted fw-bold">L√≠mite Total</label>
              <input type="number" id="c-limit" class="form-control" required />
            </div>

            <div class="mb-3">
              <label class="small text-muted fw-bold">Deuda Total</label>
              <input type="number" id="c-bal" class="form-control" value="0" required />
            </div>

            <button type="submit" class="btn btn-primary w-100 py-2 rounded-3 fw-bold">Guardar</button>
            <button type="button" id="btn-del-card" class="btn btn-link text-danger w-100 mt-2 text-decoration-none" onclick="deleteCard()">Eliminar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- =======================
        ‚úÖ MODAL META
  ======================= -->
  <div class="modal fade" id="modalGoal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-box border-0">
        <div class="modal-body">
          <h5 class="fw-black mb-3">Nueva meta</h5>
          <form id="form-goal">
            <div class="mb-3">
              <label class="small text-muted fw-bold">Nombre</label>
              <input type="text" id="goal-name" class="form-control" placeholder="Ej: Viaje" required />
            </div>
            <div class="mb-3">
              <label class="small text-muted fw-bold">Monto objetivo</label>
              <input type="number" id="goal-target" class="form-control" placeholder="0" min="0" step="0.01" required />
            </div>
            <div class="mb-3">
              <label class="small text-muted fw-bold">Prioridad</label>
              <select id="goal-priority" class="form-select">
                <option value="">‚Äî</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100 py-2 rounded-3 fw-bold">Guardar meta</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- =======================
        ‚úÖ MODAL APORTAR META
  ======================= -->
  <div class="modal fade" id="modalGoalContribution" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content card-box border-0">
        <div class="modal-body">
          <h5 class="fw-black mb-3">Aportar a meta</h5>
          <form id="form-goal-contribution">
            <input type="hidden" id="goal-contribution-id" />
            <div class="mb-3">
              <label class="small text-muted fw-bold">Monto</label>
              <input type="number" id="goal-contribution-amount" class="form-control" placeholder="0" min="0" step="0.01" required />
            </div>
            <div class="mb-3">
              <label class="small text-muted fw-bold">Owner</label>
              <select id="goal-contribution-owner" class="form-select">
                <option value="yair">Yair</option>
                <option value="haru">Haru</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="small text-muted fw-bold">Fecha</label>
              <input type="date" id="goal-contribution-date" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="small text-muted fw-bold">Nota (opcional)</label>
              <input type="text" id="goal-contribution-note" class="form-control" placeholder="Ej: Aguinaldo" />
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-light flex-fill" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary flex-fill">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- =======================
        ‚úÖ MODAL DETALLE META
  ======================= -->
  <div class="modal fade" id="modalGoalDetail" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content card-box border-0">
        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-black m-0" id="goal-detail-title">Detalle de meta</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div id="goal-detail-body">
            <div class="text-muted small">Cargando meta...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc,
      query, orderBy, writeBatch, Timestamp, enableIndexedDbPersistence, where, getDocs, getDoc, setDoc,
      serverTimestamp, increment, limit
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // =========================
    // ‚úÖ CONFIG SHEETS
    // =========================
    const SHEETS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbyf1WZ67vuH4mmhs8T6DvyirWdsVE8_uiUT4dRhbFbhJwhY7tQ2RwbTkFKRD1GV803a2A/exec";
    const SHEETS_SPREADSHEET_ID = "1DLmT0ZBk-7o43rojSelLOtkLcnu9g-Z6lRklQP93agE";

    async function sheetsSend(payload){
      try{
        const body = JSON.stringify({
          sheetId: SHEETS_SPREADSHEET_ID,
          ...payload,
          sentAt: new Date().toISOString()
        });

        await fetch(SHEETS_WEBHOOK_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body
        });
      }catch(e){
        console.log("Sheets send error:", e?.message || e);
      }
    }

    // =========================
    // ‚úÖ PWA
    // =========================
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try { await navigator.serviceWorker.register("/sw.js"); }
        catch (e) { console.log("SW no registrado (ok):", e?.message || e); }
      });
    }

    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDTDnao-bkiC4yxmV-mGryBmmvlWOvMIpg",
      authDomain: "finanzas-yayos-1738b.firebaseapp.com",
      projectId: "finanzas-yayos-1738b",
      storageBucket: "finanzas-yayos-1738b.firebasestorage.app",
      messagingSenderId: "821972200592",
      appId: "1:821972200592:web:de809935c39a319ff4bc15",
      measurementId: "G-FL2NL2H5SR"
    };

    // Loader
    const loaderEl = document.getElementById('loader');
    const loaderMsg = document.getElementById('loader-msg');
    const loaderError = document.getElementById('loader-error');
    const loaderErrorMsg = document.getElementById('loader-error-msg');
    const loaderRetryBtn = document.getElementById('loader-retry');
    let loaderTimeoutId = null;
    let loaderSoftTimeoutId = null;
    let appReady = false;

    function clearLoaderTimers(){
      if(loaderSoftTimeoutId) clearTimeout(loaderSoftTimeoutId);
      if(loaderTimeoutId) clearTimeout(loaderTimeoutId);
      loaderSoftTimeoutId = null;
      loaderTimeoutId = null;
    }

    function setLoaderMsg(msg){
      if(!loaderMsg){
        console.warn("setLoaderMsg: elemento 'loader-msg' no encontrado.");
        return;
      }
      loaderMsg.textContent=msg;
    }

    function startLoader(){
      appReady = false;
      clearLoaderTimers();
      if(loaderEl) loaderEl.style.display='flex';
      if(loaderError) loaderError.classList.add('d-none');
      setLoaderMsg("Cargando...");
      const isOffline = !navigator.onLine;
      if(isOffline){
        setLoaderMsg("Est√°s offline. Mostrando datos disponibles.");
      }

      loaderSoftTimeoutId = setTimeout(() => {
        if(appReady) return;
        if(!navigator.onLine){
          setLoaderMsg("Est√°s offline. Mostrando datos disponibles.");
          return;
        }
        setLoaderMsg("Conectando con Firestore‚Ä¶ puede tardar en datos m√≥viles.");
      }, 8000);

      if(navigator.onLine){
        loaderTimeoutId = setTimeout(() => {
          if(appReady) return;
          showStartupError("No se pudo conectar a Firestore. Revisa tu internet y vuelve a intentar.", { canRetry: true });
        }, 25000);
      }
    }

    function stopLoader(){
      clearLoaderTimers();
      if(loaderEl) loaderEl.style.display='none';
      if(loaderError) loaderError.classList.add('d-none');
    }

    function showStartupError(message, { canRetry = true } = {}){
      console.error(message);
      if(loaderEl) loaderEl.style.display='flex';
      if(loaderErrorMsg){
        loaderErrorMsg.textContent = message;
      }else{
        console.warn("showStartupError: elemento 'loader-error-msg' no encontrado.");
      }
      if(loaderRetryBtn){
        loaderRetryBtn.classList.toggle('d-none', !canRetry);
      }else{
        console.warn("showStartupError: elemento 'loader-retry' no encontrado.");
      }
      if(loaderError){
        loaderError.classList.remove('d-none');
      }else{
        console.warn("showStartupError: elemento 'loader-error' no encontrado.");
      }
    }

    function markAppReady(source){
      if(appReady) return;
      appReady = true;
      stopLoader();
      console.info("App ready via", source);
    }

    function getFirestoreErrorMessage(err){
      const code = err?.code || "";
      if(code === "permission-denied") return "Permisos de Firestore: no tienes acceso a estos datos.";
      if(code === "failed-precondition") return "Falta un √≠ndice requerido en Firestore.";
      if(code === "unavailable") return "Conexi√≥n inestable o servicio no disponible.";
      return err?.message ? `Error inesperado: ${err.message}` : "Error inesperado de Firestore.";
    }

    function unsubscribeAll(){
      if(unsubCards){
        unsubCards();
        unsubCards = null;
      }
      if(unsubTrans){
        unsubTrans();
        unsubTrans = null;
      }
      if(unsubGoals){
        unsubGoals();
        unsubGoals = null;
      }
    }

    function retryStartup(){
      unsubscribeAll();
      startLoader();
      setLoaderMsg("Reintentando conexi√≥n...");
      resubscribeAll();
    }

    if(loaderRetryBtn){
      loaderRetryBtn.addEventListener("click", retryStartup);
    }

    // Firestore init
    let app, db;
    let hasLoggedProjectId = false;
    const logProjectIdOnce = () => {
      if(hasLoggedProjectId) return;
      if(firebaseConfig?.projectId){
        console.info("Firestore projectId:", firebaseConfig.projectId);
      }
      hasLoggedProjectId = true;
    };
    try { app = initializeApp(firebaseConfig); db = getFirestore(app); }
    catch(e){ showStartupError("Error inicializando Firebase: "+(e.message||e), { canRetry: false }); }
    enableIndexedDbPersistence(db).catch((err)=>console.log("Persistence status:", err.code));
    logProjectIdOnce();

    // =========================
    // üîî PUSH (por ahora placeholder)
    // =========================
    window.enablePush = () => {
      if(sessionStorage.getItem("msi_toast_shown") === "1") return;
      sessionStorage.setItem("msi_toast_shown", "1");
      showToast("MSI pro activado: ya puedes ver cu√°ndo se liberan compras üòå", {
        tone: "info",
        duration: 2500
      });
    };

    // Presets
    const PRESET_CARDS = [
      { name: "Like u", owner: "yair" },
      { name: "Free", owner: "yair" },
      { name: "Costco", owner: "yair" },
      { name: "Mercado Pago", owner: "yair" },
      { name: "Oro", owner: "haru" },
      { name: "Simplicity", owner: "haru" },
      { name: "BBVA", owner: "haru" },
      { name: "Liverpool", owner: "haru" },
      { name: "Palacio", owner: "haru" },
      { name: "Pago c/ Transferencia", owner: "both" }
    ];

    // Owner
    const OWNER_KEY="fy_owner";
    const SCOPE_FILTER_KEY="fy_scope_filter";
    let OWNER = localStorage.getItem(OWNER_KEY) || "yair";
    const ownerSelect = document.getElementById("owner-select");
    ownerSelect.value = OWNER;

    const getActiveScopeFilter = () => localStorage.getItem(SCOPE_FILTER_KEY) || "all";

    ownerSelect.addEventListener("change", async ()=>{
      OWNER = ownerSelect.value;
      localStorage.setItem(OWNER_KEY, OWNER);
      setState({ owner: OWNER });
      dataState.owner = OWNER;
      invalidateCategoryAggCacheForOwner(OWNER);
      startLoader();
      setLoaderMsg("Cambiando usuario...");
      await seedPresetCards();
      resubscribeAll();
      periodDataCache = { owner: null, scope: null, data: null };
      cancelSimulation();
      refreshAll({ owner: OWNER, force: true, source: "owner-change" });
      updateMonthlyFootprint({ force: true });
    });

    // State
    let cards=[], trans=[], goals=[];
    let privacy=false, chartInstance=null;
    let cardModal=null;
    let goalModal=null;
    let goalDetailModal=null;
    let goalContributionModal=null;
    let unsubCards=null, unsubTrans=null, unsubGoals=null;
    let goalsLoading = true;
    let goalsError = null;
    let goalsLastErrorToastAt = 0;
    let activeGoalDetailId = null;

    let periodDataCache = { owner: null, scope: null, data: null };
    let dataRequestId = 0;
    const DEBUG_RENDER = true;
    const dataState = {
      loading: false,
      owner: OWNER,
      scopeFilter: getActiveScopeFilter(),
      periodData: null,
      lastGoodPeriodData: null,
      lastGoodMetrics: null,
      lastGoodInsights: [],
      lastGoodPrediction: null,
      lastGoodCounts: null,
      error: null
    };
    const simulationState = { active: false, amount: 0, category: "", result: null };

    // MSI state
    let msiChartInstance=null;

    const FEATURES = {
      dashboard: true,
      alerts: true,
      insights: true,
      offlineUx: true,
      timeline: true,
      prediction: true,
      simulator: true,
      gestures: true,
      darkMode: true,
      coupleMode: true,
      monthlyFootprint: true
    };

    let appState = {
      owner: OWNER,
      activeScopeFilter: localStorage.getItem(SCOPE_FILTER_KEY) || "all",
      isOnline: navigator.onLine,
      periodDataCacheKeys: [],
      ui: { loading: false, lastSync: null, toasts: [] },
      syncStatus: "synced",
      pendingWrites: false
    };

    const eventBus = new Map();
    const on = (eventName, handler) => {
      if(!eventBus.has(eventName)) eventBus.set(eventName, new Set());
      eventBus.get(eventName).add(handler);
      return () => eventBus.get(eventName)?.delete(handler);
    };
    const emit = (eventName, payload) => {
      (eventBus.get(eventName) || []).forEach((handler) => safeRun(() => handler(payload), `event:${eventName}`));
    };

    const setState = (partial = {}) => {
      const prev = { ...appState };
      appState = {
        ...appState,
        ...partial,
        ui: { ...appState.ui, ...(partial.ui || {}) }
      };
      if(partial.activeScopeFilter && prev.activeScopeFilter !== appState.activeScopeFilter){
        emit("FILTER_CHANGED", { scopeFilter: appState.activeScopeFilter });
      }
      if(typeof partial.isOnline === "boolean" && prev.isOnline !== appState.isOnline){
        emit(appState.isOnline ? "ONLINE" : "OFFLINE");
      }
    };

    let netBadgeTimer = null;

    const supportsReducedMotion = () =>
      window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    const animateIn = (el) => {
      if(!el) return;
      if(supportsReducedMotion()){
        el.classList.remove("fade-in");
        el.classList.add("is-visible");
        return;
      }
      el.classList.add("fade-in");
      el.classList.remove("is-visible");
      requestAnimationFrame(() => {
        el.classList.add("is-visible");
      });
    };

    const setLoading = (buttonEl, isLoading, { label = "Guardando..." } = {}) => {
      if(!buttonEl) return;
      if(isLoading){
        buttonEl.dataset.originalText = buttonEl.dataset.originalText || buttonEl.textContent.trim();
        buttonEl.classList.add("btn-loading", "is-loading", "btn-disabled");
        buttonEl.disabled = true;
        buttonEl.setAttribute("aria-busy", "true");
        buttonEl.innerHTML = `<span class="spinner" aria-hidden="true"></span><span class="btn-text">${label}</span>`;
        return;
      }
      buttonEl.classList.remove("btn-loading", "is-loading", "btn-disabled");
      buttonEl.disabled = false;
      buttonEl.removeAttribute("aria-busy");
      buttonEl.textContent = buttonEl.dataset.originalText || buttonEl.textContent;
    };

    const flashButtonSuccess = (buttonEl, { label = "Guardado" } = {}) => {
      if(!buttonEl) return;
      const originalText = buttonEl.dataset.originalText || buttonEl.textContent.trim();
      buttonEl.classList.add("btn-success-flash");
      buttonEl.innerHTML = `<span class="checkmark">‚úì</span><span class="btn-text">${label}</span>`;
      setTimeout(() => {
        buttonEl.classList.remove("btn-success-flash");
        buttonEl.textContent = originalText;
      }, 500);
    };

    const haptic = (type = "success") => {
      if(!navigator.vibrate) return;
      const patterns = {
        success: [10],
        warn: [20],
        error: [10, 40, 10]
      };
      navigator.vibrate(patterns[type] || patterns.success);
    };

    function showToast(message, { tone = "info", duration = 2600 } = {}){
      const container = document.getElementById("toast-container");
      if(!container) return;
      const toast = document.createElement("div");
      toast.className = `toast-message ${tone}`;
      toast.textContent = message;
      container.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add("toast-show"));
      setTimeout(() => {
        toast.classList.remove("toast-show");
        toast.classList.add("toast-hide");
        setTimeout(() => toast.remove(), 220);
      }, duration);
    }

    function safeRun(fn, context = "app"){
      try{
        return fn();
      }catch(e){
        console.error(`Error en ${context}:`, e);
        showToast("Ups‚Ä¶ algo fall√≥, pero seguimos.", { tone: "warning", duration: 2400 });
        return null;
      }
    }

    const applyFeatureVisibility = () => {
      const toggle = (id, enabled) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.toggle("d-none", !enabled);
      };
      toggle("dashboard-summary", FEATURES.dashboard);
      toggle("alerts-section", FEATURES.alerts);
      toggle("insights-section", FEATURES.insights);
      toggle("prediction-section", FEATURES.prediction);
      toggle("simulation-section", FEATURES.simulator);
      toggle("monthly-footprint-section", FEATURES.monthlyFootprint);
      toggle("scope-filter-section", FEATURES.coupleMode);
    };

    function renderConnectivityBadge(isOnline){
      const badge = document.getElementById("netBadge");
      if(!badge) return;
      badge.classList.remove("offline", "online");
      if(!isOnline){
        badge.textContent = "Offline";
        badge.classList.add("offline");
        badge.classList.remove("d-none");
        return;
      }
      badge.textContent = "Online";
      badge.classList.add("online");
      badge.classList.remove("d-none");
      if(netBadgeTimer) clearTimeout(netBadgeTimer);
      netBadgeTimer = setTimeout(() => {
        badge.classList.add("d-none");
      }, 2000);
    }

    function setSyncStatus(status, { silent = false } = {}){
      const syncEl = document.getElementById("sync-status");
      const timeEl = document.getElementById("sync-time");
      if(!syncEl) return;
      appState.syncStatus = status;
      setState({ syncStatus: status });
      syncEl.classList.remove("syncing", "synced", "local");
      if(status === "syncing"){
        syncEl.textContent = "Sincronizando...";
        syncEl.classList.add("syncing");
      }else if(status === "local"){
        syncEl.textContent = "Guardado local";
        syncEl.classList.add("local");
      }else{
        syncEl.textContent = "Sincronizado";
        syncEl.classList.add("synced");
        appState.lastSync = new Date();
        setState({ ui: { lastSync: appState.lastSync } });
        if(timeEl){
          const time = appState.lastSync.toLocaleTimeString("es-MX", { hour: "2-digit", minute: "2-digit" });
          timeEl.textContent = `√öltima sincronizaci√≥n: ${time}`;
          timeEl.classList.remove("d-none");
        }
      }
      if(!silent && status === "synced") showToast("Sincronizado", { tone: "success", duration: 1800 });
    }

    function handlePendingWrites(hasPendingWrites){
      if(hasPendingWrites){
        appState.pendingWrites = true;
        setSyncStatus("syncing", { silent: true });
        return;
      }
      if(appState.pendingWrites){
        appState.pendingWrites = false;
        setSyncStatus("synced");
      }else{
        setSyncStatus("synced", { silent: true });
      }
    }

    async function refreshAfterReconnect(){
      await refreshAll({ owner: OWNER, force: true, source: "reconnect" });
      updateAlerts({ force: true });
      updateMonthlyFootprint({ force: true });
      renderHistory();
      updateChart();
    }

    function setupConnectivityListeners(){
      renderConnectivityBadge(appState.isOnline);
      window.addEventListener("online", async () => {
        appState.isOnline = true;
        setState({ isOnline: true });
        renderConnectivityBadge(true);
        if(appState.pendingWrites) setSyncStatus("syncing", { silent: true });
        else setSyncStatus("synced", { silent: true });
        emit("ONLINE");
        await refreshAfterReconnect();
      });
      window.addEventListener("offline", () => {
        appState.isOnline = false;
        setState({ isOnline: false });
        renderConnectivityBadge(false);
        setSyncStatus("local", { silent: true });
        emit("OFFLINE");
      });
    }

    setupConnectivityListeners();
    setSyncStatus(appState.isOnline ? "synced" : "local", { silent: true });

    const formatMoney = (v) => '$' + parseFloat(v||0).toLocaleString('en-US',{minimumFractionDigits:2});

    // ===== FASE 1: HELPERS BASE =====
    const safeNumber = (n) => {
      const v = Number(n);
      return Number.isFinite(v) ? v : 0;
    };

    const normalizeScope = (scope) => {
      if(scope === "personal" || scope === "shared") return scope;
      return "shared";
    };

    const applyScopeFilter = (expenses = [], filter = getActiveScopeFilter()) => {
      if(filter === "all") return expenses;
      return expenses.filter((item) => {
        if(item?.type && item.type !== "expense") return true;
        return normalizeScope(item?.scope) === filter;
      });
    };

    const applyScopeFilterToPeriodData = (periodData = {}, filter = getActiveScopeFilter()) => ({
      ...periodData,
      month: {
        ...periodData?.month,
        current: applyScopeFilter(periodData?.month?.current || [], filter),
        previous: applyScopeFilter(periodData?.month?.previous || [], filter)
      },
      year: {
        ...periodData?.year,
        current: applyScopeFilter(periodData?.year?.current || [], filter),
        previous: applyScopeFilter(periodData?.year?.previous || [], filter)
      },
      week: periodData?.week ? {
        ...periodData.week,
        current: applyScopeFilter(periodData?.week?.current || [], filter),
        previous: applyScopeFilter(periodData?.week?.previous || [], filter)
      } : undefined
    });

    const setActiveScopeFilter = (value) => {
      const next = value === "shared" || value === "personal" ? value : "all";
      localStorage.setItem(SCOPE_FILTER_KEY, next);
      dataState.scopeFilter = next;
      setState({ activeScopeFilter: next });
      syncScopeFilterUI();
      periodDataCache = { owner: null, scope: null, data: null };
      emit("FILTER_CHANGED", { scopeFilter: next });
    };

    const scopeLabel = (value) => {
      if(value === "shared") return "Compartido";
      if(value === "personal") return "Personal";
      return "Todo";
    };

    const syncScopeFilterUI = () => {
      const value = getActiveScopeFilter();
      const label = document.getElementById("scope-filter-label");
      const all = document.getElementById("scope-filter-all");
      const shared = document.getElementById("scope-filter-shared");
      const personal = document.getElementById("scope-filter-personal");
      if(label) label.textContent = scopeLabel(value);
      if(all) all.checked = value === "all";
      if(shared) shared.checked = value === "shared";
      if(personal) personal.checked = value === "personal";
    };

    const toDate = (value) => {
      if (value && typeof value.toDate === "function") return value.toDate();
      if (value instanceof Date) return value;
      const d = new Date(value);
      return Number.isNaN(d.getTime()) ? new Date(0) : d;
    };

    const startOfMonth = (date = new Date()) => {
      const d = toDate(date);
      return new Date(d.getFullYear(), d.getMonth(), 1, 0, 0, 0, 0);
    };

    const endOfMonth = (date = new Date()) => {
      const d = toDate(date);
      return new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59, 999);
    };

    const previousMonth = (date = new Date()) => {
      const d = toDate(date);
      return new Date(d.getFullYear(), d.getMonth() - 1, 1, 0, 0, 0, 0);
    };

    const startOfYear = (date = new Date()) => {
      const d = toDate(date);
      return new Date(d.getFullYear(), 0, 1, 0, 0, 0, 0);
    };

    const endOfYear = (date = new Date()) => {
      const d = toDate(date);
      return new Date(d.getFullYear(), 11, 31, 23, 59, 59, 999);
    };

    const startOfWeek = (date = new Date()) => {
      const d = toDate(date);
      const day = d.getDay();
      const diff = day === 0 ? -6 : 1 - day;
      const monday = new Date(d);
      monday.setDate(d.getDate() + diff);
      monday.setHours(0, 0, 0, 0);
      return monday;
    };

    const endOfWeek = (date = new Date()) => {
      const monday = startOfWeek(date);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return sunday;
    };

    const formatCurrency = (value) => new Intl.NumberFormat("es-MX", {
      style: "currency",
      currency: "MXN",
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(safeNumber(value));

    const pctChange = (current, previous) => {
      const curr = safeNumber(current);
      const prev = safeNumber(previous);
      if (prev === 0) {
        if (curr > 0) return { kind: "new", value: "nuevo" };
        return { kind: "pct", value: 0 };
      }
      const raw = ((curr - prev) / prev) * 100;
      const rounded = Math.round(raw * 10) / 10;
      return { kind: "pct", value: rounded };
    };

    const sumExpenses = (expenses = []) => expenses.reduce((acc, exp) => {
      const amount = safeNumber(exp?.amount);
      return acc + amount;
    }, 0);

    const groupByCategory = (expenses = []) => expenses.reduce((acc, exp) => {
      const key = exp?.category ? exp.category : "Sin categor√≠a";
      acc[key] = safeNumber(acc[key]) + safeNumber(exp?.amount);
      return acc;
    }, {});

    const groupByWeekday = (expenses = []) => {
      const base = {
        lunes: 0,
        martes: 0,
        miercoles: 0,
        jueves: 0,
        viernes: 0,
        sabado: 0,
        domingo: 0
      };
      const labels = ["domingo", "lunes", "martes", "miercoles", "jueves", "viernes", "sabado"];
      expenses.forEach((exp) => {
        const d = toDate(exp?.date);
        if (Number.isNaN(d.getTime())) return;
        const dayLabel = labels[d.getDay()];
        base[dayLabel] = safeNumber(base[dayLabel]) + safeNumber(exp?.amount);
      });
      return base;
    };

    const startOfDay = (date = new Date()) => {
      const d = toDate(date);
      return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
    };

    const formatDayLabel = (date, now = new Date()) => {
      const day = startOfDay(date);
      const today = startOfDay(now);
      const diffDays = Math.floor((today - day) / 86400000);
      if (diffDays === 0) return "Hoy";
      if (diffDays === 1) return "Ayer";
      if (diffDays > 1 && diffDays <= 6) {
        const weekday = day.toLocaleDateString("es-MX", { weekday: "long" });
        return weekday.charAt(0).toUpperCase() + weekday.slice(1);
      }
      return day.toLocaleDateString("es-MX", { day: "numeric", month: "long", year: "numeric" });
    };

    const groupExpensesByDay = (expenses = []) => {
      const groups = new Map();
      expenses.forEach((exp) => {
        const d = toDate(exp?.date);
        if (Number.isNaN(d.getTime())) return;
        const day = startOfDay(d);
        const key = day.toISOString().split("T")[0];
        const current = groups.get(key) || { key, date: day, items: [], subtotal: 0 };
        current.items.push(exp);
        if (exp?.type === "expense") {
          current.subtotal += safeNumber(exp?.amount);
        }
        groups.set(key, current);
      });
      return Array.from(groups.values())
        .sort((a, b) => b.date - a.date)
        .map((group) => ({
          ...group,
          label: formatDayLabel(group.date, new Date()),
          items: group.items.sort((a, b) => toDate(b?.date) - toDate(a?.date))
        }));
    };

    const computePeriodTotals = (periodData = {}) => {
      const monthCurrentTotal = sumExpenses(periodData?.month?.current || []);
      const monthPreviousTotal = sumExpenses(periodData?.month?.previous || []);
      const yearCurrentTotal = sumExpenses(periodData?.year?.current || []);
      const yearPreviousTotal = sumExpenses(periodData?.year?.previous || []);

      return {
        month: {
          currentTotal: monthCurrentTotal,
          previousTotal: monthPreviousTotal,
          delta: buildDelta(monthCurrentTotal, monthPreviousTotal)
        },
        year: {
          currentTotal: yearCurrentTotal,
          previousTotal: yearPreviousTotal,
          delta: buildDelta(yearCurrentTotal, yearPreviousTotal)
        }
      };
    };

    const getPeriodCounts = (periodData = {}) => {
      const monthCurrent = periodData?.month?.current?.length || 0;
      const monthPrevious = periodData?.month?.previous?.length || 0;
      const yearCurrent = periodData?.year?.current?.length || 0;
      const yearPrevious = periodData?.year?.previous?.length || 0;
      return {
        monthCurrent,
        monthPrevious,
        yearCurrent,
        yearPrevious,
        total: monthCurrent + monthPrevious + yearCurrent + yearPrevious
      };
    };

    const isPeriodDataValid = (periodData) => getPeriodCounts(periodData).total > 0;

    const logRenderDebug = (source, periodData, { owner, scopeFilter, loading } = {}) => {
      if(!DEBUG_RENDER) return;
      const counts = getPeriodCounts(periodData);
      console.debug(`[render:${source}]`, {
        owner: owner || getActiveOwner(),
        scopeFilter: scopeFilter || getActiveScopeFilter(),
        loading: typeof loading === "boolean" ? loading : dataState.loading,
        counts,
        requestId: dataRequestId
      });
    };

    const setDataLoading = (isLoading, source = "loading") => {
      dataState.loading = isLoading;
      setState({ ui: { loading: isLoading } });
      if(DEBUG_RENDER){
        console.debug(`[loading:${source}]`, { loading: isLoading, requestId: dataRequestId });
      }
    };

    const extractIndexLink = (message = "") => {
      const match = message.match(/https?:\/\/[^\s]+/);
      return match ? match[0] : null;
    };

    const isMissingIndexError = (err) => {
      const message = (err?.message || "").toLowerCase();
      return err?.code === "failed-precondition" || message.includes("requires an index");
    };

    const formatGoalsQueryDebugInfo = (debugInfo = {}) => {
      const whereText = (debugInfo.whereFields || [])
        .map((w) => `${w.field}${w.op}${JSON.stringify(w.value)}`)
        .join(" && ");
      const orderText = (debugInfo.orderByFields || [])
        .map((o) => `${o.field} ${o.direction}`)
        .join(", ");
      const parts = [];
      if(whereText) parts.push(whereText);
      if(orderText) parts.push(`orderBy ${orderText}`);
      return parts.join(" + ");
    };

    const renderGoalsMissingIndexBanner = ({ link, debugInfo } = {}) => {
      renderMissingIndexBanner({ module: "Metas", link });
      const debugEl = document.getElementById("missing-index-goals-debug");
      if(debugEl){
        const summary = formatGoalsQueryDebugInfo(debugInfo);
        debugEl.textContent = summary ? `Query requerido: ${summary}` : "Query requerido: (sin detalles).";
      }
    };

    const renderPeriodErrorBanner = () => {
      const banner = document.getElementById("missing-index-banner");
      if(!banner) return;
      const error = dataState.error;
      if(error?.type === "missing_index"){
        banner.classList.remove("d-none");
        const link = banner.querySelector("#missing-index-link");
        if(link){
          if(error.link){
            link.href = error.link;
            link.classList.remove("d-none");
          } else {
            link.removeAttribute("href");
            link.classList.add("d-none");
          }
        }
      } else {
        banner.classList.add("d-none");
      }
    };

    const renderMissingIndexBanner = ({ module, link, bannerId, linkId } = {}) => {
      const targetBannerId = bannerId || "missing-index-goals-banner";
      const targetLinkId = linkId || "missing-index-goals-link";
      const banner = document.getElementById(targetBannerId);
      if(!banner) return;
      const title = banner.querySelector(".banner-title");
      if(title && module){
        title.textContent = `‚ö†Ô∏è Falta un √≠ndice de Firestore para cargar ${module}.`;
      }
      const linkEl = banner.querySelector(`#${targetLinkId}`);
      if(linkEl){
        if(link){
          linkEl.href = link;
          linkEl.classList.remove("d-none");
        }else{
          linkEl.removeAttribute("href");
          linkEl.classList.add("d-none");
        }
      }
      banner.classList.remove("d-none");
    };

    const hideMissingIndexBanner = (bannerId = "missing-index-goals-banner") => {
      const banner = document.getElementById(bannerId);
      if(banner) banner.classList.add("d-none");
    };

    const setPeriodError = (error = null) => {
      dataState.error = error;
      renderPeriodErrorBanner();
    };

    const resolvePeriodDataForRender = (periodData) => {
      if (periodData && isPeriodDataValid(periodData)) return periodData;
      if (dataState.loading && dataState.lastGoodPeriodData) return dataState.lastGoodPeriodData;
      return periodData;
    };

    const buildDelta = (current, previous) => {
      const curr = safeNumber(current);
      const prev = safeNumber(previous);
      const delta = curr - prev;
      const arrow = delta > 0 ? "up" : delta < 0 ? "down" : "flat";
      const pct = pctChange(curr, prev);

      if (curr === 0 && prev === 0) {
        return {
          pct,
          delta,
          arrow: "flat",
          labelPct: "Sin historial",
          labelDelta: "",
          showDelta: false
        };
      }

      if (pct.kind === "new") {
        return {
          pct,
          delta,
          arrow,
          labelPct: "nuevo",
          labelDelta: "",
          showDelta: false
        };
      }

      const pctValue = safeNumber(pct.value);
      const labelPct = `${pctValue > 0 ? "+" : ""}${pctValue}%`;
      const labelDelta = `${delta > 0 ? "+" : delta < 0 ? "-" : ""}${formatCurrency(Math.abs(delta))}`;

      return {
        pct,
        delta,
        arrow,
        labelPct,
        labelDelta,
        showDelta: true
      };
    };

    const getExpenseTrendStyle = (delta) => {
      if (delta > 0) return "trend-warn";
      if (delta < 0) return "trend-good";
      return "trend-neutral";
    };

    const buildPeriodDataFallback = (expenses = []) => {
      const now = new Date();
      const prevMonth = previousMonth(now);
      const prevYear = new Date(now.getFullYear() - 1, 0, 1);
      const onlyExpenses = (expenses || [])
        .filter((t) => t?.type === "expense")
        .map((t) => ({ ...t, date: toDate(t?.date) }));

      const withinRange = (date, start, end) => date >= start && date <= end;
      return {
        month: {
          current: onlyExpenses.filter((t) =>
            withinRange(t.date, startOfMonth(now), endOfMonth(now))
          ),
          previous: onlyExpenses.filter((t) =>
            withinRange(t.date, startOfMonth(prevMonth), endOfMonth(prevMonth))
          )
        },
        year: {
          current: onlyExpenses.filter((t) =>
            withinRange(t.date, startOfYear(now), endOfYear(now))
          ),
          previous: onlyExpenses.filter((t) =>
            withinRange(t.date, startOfYear(prevYear), endOfYear(prevYear))
          )
        }
      };
    };

    async function getPeriodData(owner, { force = false } = {}) {
      const o = getActiveOwner(owner);
      const scopeFilter = getActiveScopeFilter();
      if (!force && periodDataCache.data && periodDataCache.owner === o && periodDataCache.scope === scopeFilter) {
        return periodDataCache.data;
      }
      const useLoader = typeof window.loadPeriodData === "function";
      const periodData = useLoader
        ? await window.loadPeriodData(o, { force })
        : buildPeriodDataFallback(trans);
      const scopedData = periodData
        ? applyScopeFilterToPeriodData(periodData, scopeFilter)
        : periodData;
      periodDataCache = { owner: o, scope: scopeFilter, data: scopedData };
      return scopedData;
    }

    function renderDashboardSummary(metrics) {
      const body = document.getElementById("dashboard-summary-body");
      if (!body) return;

      if (!metrics) {
        body.innerHTML = `
          <div class="skeleton-grid">
            <div class="skeleton-card">
              <div class="skeleton skeleton-line" style="width:45%;"></div>
              <div class="skeleton skeleton-line tall" style="width:70%;"></div>
              <div class="skeleton skeleton-line" style="width:80%;"></div>
            </div>
            <div class="skeleton-card">
              <div class="skeleton skeleton-line" style="width:45%;"></div>
              <div class="skeleton skeleton-line tall" style="width:70%;"></div>
              <div class="skeleton skeleton-line" style="width:80%;"></div>
            </div>
          </div>
        `;
        return;
      }

      const arrowMap = { up: "üîº", down: "üîΩ", flat: "‚ûñ" };
      const monthTrend = getExpenseTrendStyle(metrics.month.delta.delta);
      const yearTrend = getExpenseTrendStyle(metrics.year.delta.delta);

      const buildCompareLine = (deltaInfo, label) => {
        if (deltaInfo.labelPct === "Sin historial") {
          return `${arrowMap.flat} Sin historial para comparar`;
        }
        const base = `${arrowMap[deltaInfo.arrow]} ${deltaInfo.labelPct} vs ${label}`;
        return deltaInfo.showDelta ? `${base} (${deltaInfo.labelDelta})` : base;
      };

      body.innerHTML = `
        <div class="dashboard-grid">
          <div class="dash-card">
            <div class="dash-title">Este mes</div>
            <div class="dash-total sensitive-data">${formatCurrency(metrics.month.currentTotal)}</div>
            <div class="dash-compare ${monthTrend}">
              ${buildCompareLine(metrics.month.delta, "mes pasado")}
            </div>
          </div>
          <div class="dash-card">
            <div class="dash-title">Este a√±o</div>
            <div class="dash-total sensitive-data">${formatCurrency(metrics.year.currentTotal)}</div>
            <div class="dash-compare ${yearTrend}">
              ${buildCompareLine(metrics.year.delta, "a√±o pasado")}
            </div>
          </div>
        </div>
      `;
      animateIn(body);

      if (privacy) togglePrivacy();
    }

    async function updateDashboardSummary({ force = false, periodData = null, source = "dashboard" } = {}) {
      const section = document.getElementById("dashboard-summary");
      if(!FEATURES.dashboard){
        section?.classList.add("d-none");
        return;
      }
      section?.classList.remove("d-none");
      if(!dataState.loading){
        renderDashboardSummary(null);
      }
      const owner = getActiveOwner();
      const resolvedData = periodData || await getPeriodData(owner, { force });
      const renderData = resolvePeriodDataForRender(resolvedData);
      logRenderDebug(`dashboard:${source}`, renderData, { owner });
      if (!renderData) {
        renderDashboardSummary(null);
        return;
      }
      const metrics = computePeriodTotals(renderData);
      renderDashboardSummary(metrics);
    }

    function computeInsights(owner, periodData = {}) {
      const monthCurrent = periodData?.month?.current || [];
      const monthPrevious = periodData?.month?.previous || [];
      if (!monthCurrent.length) return [];

      const insights = [];
      const categoriesCurrent = groupByCategory(monthCurrent);
      const categoriesPrevious = groupByCategory(monthPrevious);
      const weekdayTotals = groupByWeekday(monthCurrent);
      const totalMonth = sumExpenses(monthCurrent);
      const countMonth = monthCurrent.length;

      const wrapAmount = (value) => `<span class="sensitive-data">${formatCurrency(value)}</span>`;

      if (monthPrevious.length && Object.keys(categoriesCurrent).length) {
        const categoryKeys = new Set([
          ...Object.keys(categoriesCurrent),
          ...Object.keys(categoriesPrevious)
        ]);
        let maxIncrease = null;
        let maxDecrease = null;

        categoryKeys.forEach((key) => {
          const currentVal = safeNumber(categoriesCurrent[key]);
          const prevVal = safeNumber(categoriesPrevious[key]);
          const diff = currentVal - prevVal;
          if (diff > 0 && (!maxIncrease || diff > maxIncrease.delta)) {
            maxIncrease = { category: key || "Sin categor√≠a", delta: diff };
          }
          if (diff < 0 && (!maxDecrease || diff < maxDecrease.delta)) {
            maxDecrease = { category: key || "Sin categor√≠a", delta: diff };
          }
        });

        if (maxIncrease || maxDecrease) {
          let message = "";
          if (maxIncrease && maxDecrease) {
            message = `Este mes gastaron m√°s en <strong>${maxIncrease.category}</strong> (+${wrapAmount(maxIncrease.delta)}) y menos en <strong>${maxDecrease.category}</strong> (${wrapAmount(maxDecrease.delta)}).`;
          } else if (maxIncrease) {
            message = `Este mes gastaron m√°s en <strong>${maxIncrease.category}</strong> (+${wrapAmount(maxIncrease.delta)}).`;
          } else if (maxDecrease) {
            message = `Este mes gastaron menos en <strong>${maxDecrease.category}</strong> (${wrapAmount(maxDecrease.delta)}).`;
          }
          if (message) {
            insights.push({
              id: "category-delta",
              title: "Cambio por categor√≠a",
              message,
              priority: 1,
              icon: "üìà"
            });
          }
        }
      } else {
        insights.push({
          id: "category-neutral",
          title: "Cambio por categor√≠a",
          message: "A√∫n falta historial para comparar categor√≠as.",
          priority: 4,
          icon: "üìå"
        });
      }

      const weekdayEntries = Object.entries(weekdayTotals);
      if (weekdayEntries.length) {
        weekdayEntries.sort((a, b) => b[1] - a[1]);
        const topValue = weekdayEntries[0][1];
        if (topValue > 0) {
          const topDays = weekdayEntries
            .filter(([, value]) => value === topValue)
            .slice(0, 2)
            .map(([day]) => day);
          const dayText = topDays.join(" y ");
          insights.push({
            id: "weekday-top",
            title: "D√≠a m√°s gast√≥n",
            message: `El <strong>${dayText}</strong> es el d√≠a donde m√°s gastan.`,
            priority: 2,
            icon: "üóìÔ∏è"
          });
        }
      }

      if (countMonth > 0) {
        const avgTicket = totalMonth / countMonth;
        insights.push({
          id: "avg-ticket",
          title: "Ticket promedio",
          message: `Tu gasto promedio por compra fue ${wrapAmount(avgTicket)} este mes.`,
          priority: 3,
          icon: "üßæ"
        });
      }

      const topExpenses = [...monthCurrent]
        .filter((t) => safeNumber(t?.amount) > 0)
        .sort((a, b) => safeNumber(b.amount) - safeNumber(a.amount))
        .slice(0, 3);
      if (topExpenses.length) {
        const labels = topExpenses.map((t) => {
          const label = (t.concept || t.cardName || t.category || "(sin concepto)").trim();
          return `${label} ${wrapAmount(t.amount)}`;
        });
        insights.push({
          id: "top-expenses",
          title: "Top gastos del mes",
          message: `Top gastos: ${labels.join(", ")}.`,
          priority: 5,
          icon: "üè∑Ô∏è"
        });
      }

      const categoryCounts = monthCurrent.reduce((acc, item) => {
        const key = item?.category || "Sin categor√≠a";
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
      const categoryEntries = Object.entries(categoryCounts);
      if (categoryEntries.length > 1) {
        categoryEntries.sort((a, b) => b[1] - a[1]);
        const topCategory = categoryEntries[0];
        if (topCategory && topCategory[1] > 1) {
          insights.push({
            id: "freq-category",
            title: "Categor√≠a m√°s frecuente",
            message: `La categor√≠a m√°s repetida fue <strong>${topCategory[0]}</strong>.`,
            priority: 6,
            icon: "üìä"
          });
        }
      }

      return insights
        .sort((a, b) => a.priority - b.priority)
        .slice(0, 5);
    }

    function renderInsights(insights = []) {
      const section = document.getElementById("insights-section");
      const list = document.getElementById("insights-list");
      if (!section || !list) return;

      if (!insights.length) {
        section.classList.remove("d-none");
        if (dataState.loading) {
          list.classList.add("is-loading");
          list.innerHTML = `
            <div class="insight-item">
              <div class="insight-icon">üí°</div>
              <div class="insight-content" style="flex:1;">
                <div class="skeleton skeleton-line" style="width:55%;"></div>
                <div class="skeleton skeleton-line" style="width:85%;"></div>
              </div>
            </div>
            <div class="insight-item">
              <div class="insight-icon">‚ú®</div>
              <div class="insight-content" style="flex:1;">
                <div class="skeleton skeleton-line" style="width:45%;"></div>
                <div class="skeleton skeleton-line" style="width:70%;"></div>
              </div>
            </div>
          `;
          return;
        }
        list.classList.remove("is-loading");
        list.innerHTML = '<small class="text-muted">A√∫n no hay suficientes movimientos para generar insights de este mes.</small>';
        animateIn(section);
        return;
      }

      list.classList.remove("is-loading");
      list.innerHTML = insights.map((item) => `
        <div class="insight-item">
          <div class="insight-icon">${item.icon || "üí°"}</div>
          <div class="insight-content">
            <div class="insight-title">${item.title}</div>
            <div class="small text-muted">${item.message}</div>
          </div>
        </div>
      `).join("");
      section.classList.remove("d-none");
      animateIn(section);

      if (privacy) togglePrivacy();
    }

    async function updateInsights({ force = false, periodData = null, source = "insights" } = {}) {
      const section = document.getElementById("insights-section");
      const list = document.getElementById("insights-list");
      if(!FEATURES.insights){
        section?.classList.add("d-none");
        return;
      }
      if (section && list) {
        section.classList.remove("d-none");
        if(!dataState.loading){
          list.classList.add("is-loading");
          list.innerHTML = `
            <div class="insight-item">
              <div class="insight-icon">üí°</div>
              <div class="insight-content" style="flex:1;">
                <div class="skeleton skeleton-line" style="width:55%;"></div>
                <div class="skeleton skeleton-line" style="width:85%;"></div>
              </div>
            </div>
            <div class="insight-item">
              <div class="insight-icon">‚ú®</div>
              <div class="insight-content" style="flex:1;">
                <div class="skeleton skeleton-line" style="width:45%;"></div>
                <div class="skeleton skeleton-line" style="width:70%;"></div>
              </div>
            </div>
          `;
        }
      }
      const owner = getActiveOwner();
      const resolvedData = periodData || await getPeriodData(owner, { force });
      const renderData = resolvePeriodDataForRender(resolvedData);
      logRenderDebug(`insights:${source}`, renderData, { owner });
      const insights = renderData ? computeInsights(owner, renderData) : [];
      renderInsights(insights);
    }

    const computeMonthlyAverage = (expenses = []) => {
      const totals = expenses.reduce((acc, exp) => {
        const d = toDate(exp?.date);
        if (Number.isNaN(d.getTime())) return acc;
        const key = `${d.getFullYear()}-${d.getMonth()}`;
        acc[key] = safeNumber(acc[key]) + safeNumber(exp?.amount);
        return acc;
      }, {});
      const values = Object.values(totals).filter((value) => value > 0);
      if (!values.length) return 0;
      return values.reduce((sum, value) => sum + value, 0) / values.length;
    };

    const computeMonthlyPrediction = (periodData = {}, { extraAmount = 0 } = {}) => {
      const now = toDate(periodData?.now || new Date());
      const monthCurrent = periodData?.month?.current || [];
      const monthPrevious = periodData?.month?.previous || [];
      const yearCurrent = periodData?.year?.current || [];
      const monthTotal = sumExpenses(monthCurrent) + safeNumber(extraAmount);
      const monthStart = startOfMonth(now);
      const daysElapsed = Math.max(1, Math.floor((startOfDay(now) - monthStart) / 86400000) + 1);
      const daysTotal = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      const txCount = monthCurrent.length;

      if (daysElapsed < 5 || txCount < 3) {
        return {
          show: false,
          reason: "A√∫n hay pocos datos para una predicci√≥n confiable."
        };
      }

      const predictedTotal = (monthTotal / daysElapsed) * daysTotal;
      const avgMonthly = computeMonthlyAverage(yearCurrent);
      const lastMonthTotal = sumExpenses(monthPrevious);

      let baseline = 0;
      if (avgMonthly > 0 && lastMonthTotal > 0) baseline = (avgMonthly + lastMonthTotal) / 2;
      else if (avgMonthly > 0) baseline = avgMonthly;
      else if (lastMonthTotal > 0) baseline = lastMonthTotal;

      let status = { tone: "neutral", label: "Sin historial" };
      if (baseline > 0) {
        const delta = (predictedTotal - baseline) / baseline;
        if (delta <= 0.05) status = { tone: "success", label: "Dentro de lo normal" };
        else if (delta <= 0.15) status = { tone: "warning", label: "Ligeramente arriba" };
        else status = { tone: "danger", label: "Muy arriba" };
      }

      return {
        show: true,
        predictedTotal,
        daysElapsed,
        daysTotal,
        monthTotal,
        avgMonthly,
        lastMonthTotal,
        baseline,
        status
      };
    };

    const computeSimulationImpact = (simAmount, periodData) => {
      const base = computeMonthlyPrediction(periodData);
      const simulated = computeMonthlyPrediction(periodData, { extraAmount: simAmount });
      const delta = base?.show && simulated?.show
        ? simulated.predictedTotal - base.predictedTotal
        : null;
      return { base, simulated, delta };
    };

    const renderPrediction = (prediction) => {
      const section = document.getElementById("prediction-section");
      const statusEl = document.getElementById("prediction-status");
      const body = document.getElementById("prediction-body");
      if (!section || !statusEl || !body) return;

      if (!prediction) {
        body.innerHTML = `
          <div class="skeleton skeleton-line" style="width:55%;"></div>
          <div class="skeleton skeleton-line" style="width:80%;"></div>
        `;
        statusEl.textContent = "Calculando";
        statusEl.className = "badge-status bg-neutral-light";
        return;
      }

      if (!prediction.show) {
        if (dataState.loading) {
          body.innerHTML = `
            <div class="skeleton skeleton-line" style="width:55%;"></div>
            <div class="skeleton skeleton-line" style="width:80%;"></div>
          `;
          statusEl.textContent = "Calculando";
          statusEl.className = "badge-status bg-neutral-light";
          return;
        }
        statusEl.textContent = "Pocos datos";
        statusEl.className = "badge-status bg-neutral-light";
        body.innerHTML = `
          <div>${prediction.reason}</div>
          <div class="text-muted mt-1">Sigue registrando gastos para desbloquear la predicci√≥n.</div>
        `;
        animateIn(section);
        return;
      }

      const badgeMap = {
        success: "bg-success-light",
        warning: "bg-warning-light",
        danger: "bg-danger-light",
        neutral: "bg-neutral-light"
      };
      statusEl.textContent = prediction.status.label;
      statusEl.className = `badge-status ${badgeMap[prediction.status.tone] || "bg-neutral-light"}`;

      const baseParts = [];
      if (prediction.avgMonthly > 0) {
        baseParts.push(`Promedio hist√≥rico: <span class="sensitive-data">${formatCurrency(prediction.avgMonthly)}</span>`);
      }
      if (prediction.lastMonthTotal > 0) {
        baseParts.push(`Mes pasado: <span class="sensitive-data">${formatCurrency(prediction.lastMonthTotal)}</span>`);
      }

      body.innerHTML = `
        <div class="fw-bold">
          A este ritmo, cerrar√°s el mes en
          <span class="sensitive-data">${formatCurrency(prediction.predictedTotal)}</span>.
        </div>
        <div class="text-muted mt-1">Basado en ${prediction.daysElapsed} de ${prediction.daysTotal} d√≠as.</div>
        ${baseParts.length ? `<div class="text-muted mt-1">${baseParts.join(" ‚Ä¢ ")}</div>` : ""}
      `;
      animateIn(section);
      if (privacy) togglePrivacy();
    };

    const renderSimulationResult = (result) => {
      const statusEl = document.getElementById("simulation-status");
      const container = document.getElementById("simulation-result");
      if (!statusEl || !container) return;

      if (!result) {
        container.classList.add("d-none");
        container.classList.remove("sim-active");
        statusEl.classList.add("d-none");
        return;
      }

      statusEl.classList.remove("d-none");
      container.classList.remove("d-none");
      container.classList.add("sim-active");

      if (!result.simulated?.show) {
        container.innerHTML = `
          <div class="text-muted">${result.simulated?.reason || "No hay suficientes datos para simular."}</div>
        `;
        return;
      }

      const delta = result.delta;
      const deltaLabel = (typeof delta === "number")
        ? `${delta >= 0 ? "+" : "-"}${formatCurrency(Math.abs(delta))}`
        : null;
      const deltaColor = delta >= 0 ? "text-danger" : "text-success";

      container.innerHTML = `
        <div class="simulation-label">Nueva predicci√≥n mensual</div>
        <div class="simulation-value sensitive-data">${formatCurrency(result.simulated.predictedTotal)}</div>
        ${deltaLabel ? `
          <div class="small ${deltaColor} mt-1">
            ${deltaLabel} vs predicci√≥n actual
          </div>
        ` : ""}
        <button class="btn btn-sm btn-outline-secondary mt-2" type="button" onclick="convertSimulationToReal()">
          Convertir en gasto real
        </button>
      `;
      if (privacy) togglePrivacy();
    };

    async function updatePrediction({ force = false, periodData = null, source = "prediction" } = {}) {
      const section = document.getElementById("prediction-section");
      if(!FEATURES.prediction){
        section?.classList.add("d-none");
        return;
      }
      section?.classList.remove("d-none");
      if(!dataState.loading){
        renderPrediction(null);
      }
      const owner = getActiveOwner();
      const resolvedData = periodData || await getPeriodData(owner, { force });
      const renderData = resolvePeriodDataForRender(resolvedData);
      logRenderDebug(`prediction:${source}`, renderData, { owner });
      const prediction = renderData ? computeMonthlyPrediction(renderData) : null;
      renderPrediction(prediction);
      if (simulationState.active) {
        simulationState.result = computeSimulationImpact(simulationState.amount, renderData || resolvedData);
        renderSimulationResult(simulationState.result);
      }
    }

    async function refreshAll({ owner, force = false, source = "refreshAll" } = {}) {
      const resolvedOwner = getActiveOwner(owner || dataState.owner);
      if(!resolvedOwner){
        console.warn("refreshAll: owner indefinido, se mantiene √∫ltimo owner v√°lido.");
        return;
      }
      dataState.owner = resolvedOwner;
      dataState.scopeFilter = getActiveScopeFilter();
      const requestId = ++dataRequestId;
      setDataLoading(true, `${source}:start`);

      if (dataState.lastGoodPeriodData && isPeriodDataValid(dataState.lastGoodPeriodData)) {
        const metrics = dataState.lastGoodMetrics || computePeriodTotals(dataState.lastGoodPeriodData);
        const insights = dataState.lastGoodInsights.length
          ? dataState.lastGoodInsights
          : computeInsights(resolvedOwner, dataState.lastGoodPeriodData);
        const prediction = dataState.lastGoodPrediction || computeMonthlyPrediction(dataState.lastGoodPeriodData);
        renderDashboardSummary(metrics);
        renderInsights(insights);
        renderPrediction(prediction);
        if (simulationState.active) {
          simulationState.result = computeSimulationImpact(simulationState.amount, dataState.lastGoodPeriodData);
          renderSimulationResult(simulationState.result);
        }
        logRenderDebug(`${source}:last-good`, dataState.lastGoodPeriodData, {
          owner: resolvedOwner,
          scopeFilter: dataState.scopeFilter,
          loading: true
        });
      } else {
        renderDashboardSummary(null);
        renderInsights([]);
        renderPrediction(null);
        logRenderDebug(`${source}:loading`, null, {
          owner: resolvedOwner,
          scopeFilter: dataState.scopeFilter,
          loading: true
        });
      }

      let periodData = null;
      try {
        periodData = await getPeriodData(resolvedOwner, { force });
      } catch (err) {
        console.warn("refreshAll: error cargando periodData", err);
      }

      if (requestId !== dataRequestId) {
        if(DEBUG_RENDER){
          console.debug(`[refreshAll:${source}] Resultado descartado`, { requestId, latest: dataRequestId });
        }
        return;
      }

      dataState.periodData = periodData;
      setDataLoading(false, `${source}:done`);
      const renderData = resolvePeriodDataForRender(periodData);
      if (!renderData) {
        renderDashboardSummary(null);
        renderInsights([]);
        renderPrediction(null);
        logRenderDebug(`${source}:empty`, periodData, {
          owner: resolvedOwner,
          scopeFilter: dataState.scopeFilter,
          loading: false
        });
        return;
      }

      const metrics = computePeriodTotals(renderData);
      const insights = computeInsights(resolvedOwner, renderData);
      const prediction = computeMonthlyPrediction(renderData);
      renderDashboardSummary(metrics);
      renderInsights(insights);
      renderPrediction(prediction);

      if (simulationState.active) {
        simulationState.result = computeSimulationImpact(simulationState.amount, renderData);
        renderSimulationResult(simulationState.result);
      }

      logRenderDebug(`${source}:render`, renderData, {
        owner: resolvedOwner,
        scopeFilter: dataState.scopeFilter,
        loading: false
      });

      if (isPeriodDataValid(renderData)) {
        dataState.lastGoodPeriodData = renderData;
        dataState.lastGoodMetrics = metrics;
        dataState.lastGoodInsights = insights;
        dataState.lastGoodPrediction = prediction;
        dataState.lastGoodCounts = getPeriodCounts(renderData);
      }
    }

    // =========================
    // ‚úÖ HUELLA MENSUAL + YO VS YO
    // =========================
    const MONTHLY_SUMMARY_COLLECTION = "monthly_summaries";

    const buildMonthlySummaryId = (owner, periodKey, scopeFilter) =>
      `${owner}__${periodKey}__${scopeFilter || "all"}`;

    const buildMonthlyNarrative = (summary) => {
      if(!summary || !summary.counts?.txCount) return "";
      const notes = [];
      const topCategory = (summary.highlights?.topCategory || "").toLowerCase();
      if(topCategory.includes("salida") || topCategory.includes("comida")){
        notes.push("Mes movido: subieron las salidas; ojo con el ritmo.");
      }
      if(topCategory.includes("servicio") || topCategory.includes("fijo")){
        notes.push("Buen control en fijos; se nota orden.");
      }
      if(summary.highlights?.avgTicket && summary.counts.txCount <= 5){
        notes.push("Compras menos frecuentes pero m√°s grandes.");
      }
      return notes.slice(0, 2).join(" ");
    };

    const computeMonthlySummary = (expenses = [], allExpenses = [], { owner, periodKey, scopeFilter } = {}) => {
      const normalized = expenses.map((item) => ({ ...item, scope: normalizeScope(item?.scope) }));
      const normalizedAll = (allExpenses.length ? allExpenses : expenses).map((item) => ({
        ...item,
        scope: normalizeScope(item?.scope)
      }));

      const total = sumExpenses(normalized);
      const txCount = normalized.length;
      const byCategoryTotals = groupByCategory(normalized);
      const byCategory = Object.entries(byCategoryTotals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([category, value]) => ({ category, total: value }));

      const byScope = normalizedAll.reduce((acc, item) => {
        if(item?.type && item.type !== "expense") return acc;
        const scope = normalizeScope(item?.scope);
        acc[scope] = safeNumber(acc[scope]) + safeNumber(item?.amount);
        return acc;
      }, { shared: 0, personal: 0 });

      const weekdayTotals = groupByWeekday(normalized);
      const topDayEntry = Object.entries(weekdayTotals).sort((a, b) => b[1] - a[1])[0];
      const topDay = topDayEntry && topDayEntry[1] > 0 ? topDayEntry[0] : null;

      const avgTicket = txCount > 0 ? total / txCount : 0;
      const topCategory = byCategory[0]?.category || null;

      const summary = {
        owner,
        periodKey,
        scopeFilter: scopeFilter || "all",
        createdAt: Timestamp.now(),
        totals: {
          total,
          byCategory,
          byWeekday: weekdayTotals,
          byScope
        },
        counts: { txCount },
        highlights: {
          topCategory,
          topDay,
          avgTicket
        }
      };
      summary.narrative = buildMonthlyNarrative(summary);
      return summary;
    };

    const saveMonthlySummary = async (summary) => {
      if(!summary) return null;
      const id = buildMonthlySummaryId(summary.owner, summary.periodKey, summary.scopeFilter);
      await setDoc(doc(db, MONTHLY_SUMMARY_COLLECTION, id), summary, { merge: true });
      return summary;
    };

    const maybeGenerateMonthlySummary = async (owner, { force = false, scopeFilter = getActiveScopeFilter() } = {}) => {
      const o = getActiveOwner(owner);
      const periodKey = getMonthKey(previousMonth(new Date()));
      const summaryId = buildMonthlySummaryId(o, periodKey, scopeFilter);
      const docRef = doc(db, MONTHLY_SUMMARY_COLLECTION, summaryId);

      if(!force){
        const existing = await getDoc(docRef);
        if(existing.exists()) return existing.data();
      }

      const monthExpenses = await loadExpensesMonthOffset(o, 1, { force });
      const normalizedAll = monthExpenses.map((item) => ({ ...item, scope: normalizeScope(item?.scope) }));
      const scopedExpenses = applyScopeFilter(normalizedAll, scopeFilter);

      if(!scopedExpenses.length) return null;

      const summary = computeMonthlySummary(scopedExpenses, normalizedAll, {
        owner: o,
        periodKey,
        scopeFilter
      });
      await saveMonthlySummary(summary);
      return summary;
    };

    const loadMonthlySummaries = async (owner, lastN = 6, scopeFilter = getActiveScopeFilter()) => {
      const o = getActiveOwner(owner);
      const snap = await getDocs(query(collection(db, MONTHLY_SUMMARY_COLLECTION), where("owner", "==", o)));
      const summaries = [];
      snap.forEach((docSnap) => {
        const data = docSnap.data();
        if(scopeFilter === "all"){
          if((data.scopeFilter || "all") !== "all") return;
        }else if(data.scopeFilter !== scopeFilter){
          return;
        }
        summaries.push(data);
      });
      summaries.sort((a, b) => (b.periodKey || "").localeCompare(a.periodKey || ""));
      return summaries.slice(0, lastN);
    };

    const computeComparisons = (summary, summaries = []) => {
      if(!summary) return null;
      const totals = summaries.map((item) => safeNumber(item?.totals?.total)).filter((value) => value > 0);
      if(!totals.length) return null;

      const avg6 = totals.length >= 6
        ? totals.slice(0, 6).reduce((acc, val) => acc + val, 0) / 6
        : null;
      const best = totals.length >= 3 ? Math.min(...totals) : null;

      const currentIndex = summaries.findIndex((item) => item.periodKey === summary.periodKey);
      const prevSummary = currentIndex >= 0 ? summaries[currentIndex + 1] : null;
      const prevTotal = prevSummary ? safeNumber(prevSummary.totals?.total) : null;

      return { avg6, best, prevTotal };
    };

    const renderMonthlyFootprint = (summary, comparisons) => {
      const section = document.getElementById("monthly-footprint-section");
      const body = document.getElementById("monthly-footprint-body");
      const periodEl = document.getElementById("monthly-footprint-period");
      if(!section || !body) return;

      if(!summary){
        body.innerHTML = '<small class="text-muted">A√∫n no hay datos suficientes para cerrar el mes anterior.</small>';
        section.classList.remove("d-none");
        return;
      }

      const periodText = summary.periodKey ? `Cierre ${summary.periodKey}` : "Cierre del mes anterior";
      if(periodEl) periodEl.textContent = periodText;

      const scopeTotals = summary.totals?.byScope || { shared: 0, personal: 0 };
      const comparisonLines = [];
      if(comparisons?.avg6){
        const delta = pctChange(summary.totals.total, comparisons.avg6);
        const label = delta.kind === "pct" ? `${delta.value > 0 ? "+" : ""}${delta.value}%` : delta.value;
        comparisonLines.push(`Vs promedio 6 meses: <strong>${label}</strong>`);
      }
      if(comparisons?.best){
        const delta = pctChange(summary.totals.total, comparisons.best);
        const label = delta.kind === "pct" ? `${delta.value > 0 ? "+" : ""}${delta.value}%` : delta.value;
        comparisonLines.push(`Vs tu mejor mes: <strong>${label}</strong>`);
      }
      if(comparisons?.prevTotal){
        const delta = pctChange(summary.totals.total, comparisons.prevTotal);
        const label = delta.kind === "pct" ? `${delta.value > 0 ? "+" : ""}${delta.value}%` : delta.value;
        comparisonLines.push(`Vs mes anterior: <strong>${label}</strong>`);
      }

      const topCategories = (summary.totals?.byCategory || [])
        .map((item) => `${item.category}: ${formatCurrency(item.total)}`)
        .join(" ‚Ä¢ ");

      body.innerHTML = `
        <div class="mb-2">
          <div><strong>Total:</strong> <span class="sensitive-data">${formatCurrency(summary.totals.total)}</span></div>
          <div class="text-muted small">
            Compartido: <span class="sensitive-data">${formatCurrency(scopeTotals.shared)}</span> ¬∑
            Personal: <span class="sensitive-data">${formatCurrency(scopeTotals.personal)}</span>
          </div>
        </div>
        ${topCategories ? `<div class="small text-muted mb-2">Top categor√≠as: ${topCategories}</div>` : ""}
        ${summary.narrative ? `<div class="small mb-2">‚Äú${summary.narrative}‚Äù</div>` : ""}
        ${comparisonLines.length
          ? `<div class="small">${comparisonLines.join("<br>")}</div>`
          : '<div class="small text-muted">A√∫n falta historial para comparaciones.</div>'}
      `;

      section.classList.remove("d-none");
      animateIn(section);
      if(privacy) togglePrivacy();
    };

    async function updateMonthlyFootprint({ force = false } = {}){
      const section = document.getElementById("monthly-footprint-section");
      const body = document.getElementById("monthly-footprint-body");
      if(!section || !body) return;
      if(!FEATURES.monthlyFootprint){
        section.classList.add("d-none");
        return;
      }
      section.classList.remove("d-none");
      body.innerHTML = '<small class="text-muted">Generando resumen...</small>';
      const owner = getActiveOwner();
      const scopeFilter = getActiveScopeFilter();
      const summary = await maybeGenerateMonthlySummary(owner, { force, scopeFilter });
      const summaries = await loadMonthlySummaries(owner, 6, scopeFilter);
      const comparisons = summary ? computeComparisons(summary, summaries) : null;
      renderMonthlyFootprint(summary, comparisons);
    }

    window.manualCloseMonth = async () => {
      await updateMonthlyFootprint({ force: true });
      showToast("Resumen mensual actualizado.", { tone: "success", duration: 2000 });
    };

    window.runSimulation = async () => {
      const amountInput = document.getElementById("sim-amount");
      const categoryInput = document.getElementById("sim-category");
      const amount = safeNumber(amountInput?.value);
      const category = (categoryInput?.value || "").trim();

      if (!amount || amount <= 0) {
        showToast("Ingresa un monto v√°lido para simular.", { tone: "warning", duration: 2200 });
        haptic("warn");
        return;
      }

      const periodData = await getPeriodData(getActiveOwner(), { force: false });
      simulationState.active = true;
      simulationState.amount = amount;
      simulationState.category = category;
      simulationState.result = computeSimulationImpact(amount, periodData);
      renderSimulationResult(simulationState.result);
    };

    window.cancelSimulation = () => {
      simulationState.active = false;
      simulationState.amount = 0;
      simulationState.category = "";
      simulationState.result = null;
      const amountInput = document.getElementById("sim-amount");
      const categoryInput = document.getElementById("sim-category");
      if (amountInput) amountInput.value = "";
      if (categoryInput) categoryInput.value = "";
      renderSimulationResult(null);
    };

    window.convertSimulationToReal = () => {
      if (!simulationState.active) return;
      nav("view-add");
      document.getElementById("t-exp").checked = true;
      uiUpdateCats();
      uiToggleScope();
      document.getElementById("t-scope-shared").checked = true;
      document.getElementById("t-amount").value = simulationState.amount;
      const catSelect = document.getElementById("t-cat");
      if (simulationState.category) {
        const hasOption = [...catSelect.options].some((opt) => opt.value === simulationState.category);
        if (!hasOption) {
          const opt = document.createElement("option");
          opt.value = simulationState.category;
          opt.textContent = simulationState.category;
          catSelect.appendChild(opt);
        }
        catSelect.value = simulationState.category;
      }
      if (!document.getElementById("t-concept").value) {
        document.getElementById("t-concept").value = "Simulaci√≥n";
      }
      document.getElementById("t-date").value = toLocalYYYYMMDD(new Date());
      cancelSimulation();
      showToast("Simulaci√≥n cargada en el formulario. Solo falta guardar üòâ", { tone: "info", duration: 2600 });
    };

    // FASE 1 - Helpers base listos

    // ===== FASE 2: RANGOS + CACHE (sesi√≥n) =====
    const expensesCache = new Map();

    const getActiveOwner = (owner) =>
      owner || OWNER || dataState.owner || localStorage.getItem(OWNER_KEY) || "yair";

    const getCacheKey = ({ owner, periodKey, start, end }) => {
      const s = toDate(start).getTime();
      const e = toDate(end).getTime();
      return `${owner}::${periodKey}::${s}::${e}`;
    };

    const getCachedExpenses = (key) => expensesCache.get(key) || null;

    const setCachedExpenses = (key, expenses) => {
      expensesCache.set(key, expenses);
    };

    const invalidateCacheKey = (key) => {
      expensesCache.delete(key);
    };

    const invalidateCacheForOwner = (owner) => {
      const prefix = `${owner}::`;
      Array.from(expensesCache.keys()).forEach((key) => {
        if (key.startsWith(prefix)) expensesCache.delete(key);
      });
    };

    async function fetchExpensesByRange({ owner, start, end, type = "expense" }) {
      const o = getActiveOwner(owner);
      const rangeStart = toDate(start);
      const rangeEnd = toDate(end);
      try {
        const qRange = query(
          collection(db, "expenses"),
          where("owner", "==", o),
          where("type", "==", type),
          where("date", ">=", rangeStart),
          where("date", "<=", rangeEnd),
          orderBy("date", "asc")
        );
        const snap = await getDocs(qRange);
        const results = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data();
          results.push({
            id: docSnap.id,
            ...data,
            date: toDate(data?.date),
            scope: normalizeScope(data?.scope)
          });
        });
        return results;
      } catch (err) {
        const baseMsg = "Error consultando expenses por rango.";
        const needsIndex = isMissingIndexError(err);
        if (needsIndex) {
          const link = extractIndexLink(err?.message || "");
          console.error(
            `${baseMsg} Falta √≠ndice compuesto: owner + type + date (asc).`,
            err
          );
          const missingIndexError = new Error(baseMsg);
          missingIndexError.type = "missing_index";
          missingIndexError.link = link;
          missingIndexError.original = err;
          throw missingIndexError;
        }
        console.error(baseMsg, err);
        throw err;
      }
    }

    async function loadExpensesByPeriod(owner, { start, end, periodKey, force = false } = {}) {
      const o = getActiveOwner(owner);
      const key = getCacheKey({ owner: o, periodKey, start, end });
      if (!force) {
        const cached = getCachedExpenses(key);
        if (cached) return cached;
      }
      const expenses = await fetchExpensesByRange({ owner: o, start, end, type: "expense" });
      setCachedExpenses(key, expenses);
      return expenses;
    }

    async function loadExpensesMonthCurrent(owner, { force = false } = {}) {
      const now = new Date();
      return loadExpensesByPeriod(owner, {
        start: startOfMonth(now),
        end: endOfMonth(now),
        periodKey: "month-current",
        force
      });
    }

    async function loadExpensesMonthPrevious(owner, { force = false } = {}) {
      const now = new Date();
      const prev = previousMonth(now);
      return loadExpensesByPeriod(owner, {
        start: startOfMonth(prev),
        end: endOfMonth(prev),
        periodKey: "month-previous",
        force
      });
    }

    async function loadExpensesYearCurrent(owner, { force = false } = {}) {
      const now = new Date();
      return loadExpensesByPeriod(owner, {
        start: startOfYear(now),
        end: endOfYear(now),
        periodKey: "year-current",
        force
      });
    }

    async function loadExpensesYearPrevious(owner, { force = false } = {}) {
      const now = new Date();
      const prevYear = new Date(now.getFullYear() - 1, 0, 1);
      return loadExpensesByPeriod(owner, {
        start: startOfYear(prevYear),
        end: endOfYear(prevYear),
        periodKey: "year-previous",
        force
      });
    }

    async function loadExpensesWeekCurrent(owner, { force = false } = {}) {
      const now = new Date();
      return loadExpensesByPeriod(owner, {
        start: startOfWeek(now),
        end: endOfWeek(now),
        periodKey: "week-current",
        force
      });
    }

    window.loadPeriodData = async (owner, { force = false } = {}) => {
      const o = getActiveOwner(owner);
      try {
        const [monthCurrent, monthPrevious, yearCurrent, yearPrevious, weekCurrent] = await Promise.all([
          loadExpensesMonthCurrent(o, { force }),
          loadExpensesMonthPrevious(o, { force }),
          loadExpensesYearCurrent(o, { force }),
          loadExpensesYearPrevious(o, { force }),
          loadExpensesWeekCurrent(o, { force })
        ]);
        setPeriodError(null);
        return {
          owner: o,
          now: new Date(),
          month: { current: monthCurrent, previous: monthPrevious },
          year: { current: yearCurrent, previous: yearPrevious },
          week: { current: weekCurrent }
        };
      } catch (err) {
        if (err?.type === "missing_index" || isMissingIndexError(err?.original)) {
          setPeriodError({
            type: "missing_index",
            message: err.message,
            link: err.link
          });
          console.warn("loadPeriodData: missing index, se reutiliza periodData previo.", err);
          return dataState.periodData || dataState.lastGoodPeriodData || null;
        }
        throw err;
      }
    };

    window.loadExpensesMonthCurrent = loadExpensesMonthCurrent;
    window.loadExpensesMonthPrevious = loadExpensesMonthPrevious;
    window.loadExpensesYearCurrent = loadExpensesYearCurrent;
    window.loadExpensesYearPrevious = loadExpensesYearPrevious;
    window.loadExpensesWeekCurrent = loadExpensesWeekCurrent;
    window.fetchExpensesByRange = fetchExpensesByRange;
    window.invalidateCacheForOwner = invalidateCacheForOwner;
    window.invalidateCacheKey = invalidateCacheKey;

    // Online/offline
    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
    function updateStatus(){
      const s=document.getElementById('connection-status');
      if(!s){
        const badge=document.getElementById('netBadge');
        if(badge){
          badge.textContent = navigator.onLine ? 'Online' : 'Offline';
          badge.classList.toggle('online', navigator.onLine);
          badge.classList.toggle('offline', !navigator.onLine);
        }else{
          console.warn("updateStatus: elemento 'connection-status' no encontrado.");
        }
        return;
      }
      if(navigator.onLine){ s.innerHTML='Online üü¢'; s.className='text-muted fw-bold'; }
      else{ s.innerHTML='Offline üî¥'; s.className='text-danger fw-bold'; }
    }
    updateStatus();

    // Nav + toggles
    window.nav=(vid)=>{
      document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
      document.getElementById(vid).classList.add('active');

      if(vid.includes('home')) document.getElementById('nav-home').classList.add('active');
      if(vid.includes('cards')) document.getElementById('nav-cards').classList.add('active');
      if(vid.includes('hist')) document.getElementById('nav-hist').classList.add('active');
      if(vid.includes('msi')) document.getElementById('nav-msi').classList.add('active');
      if(vid.includes('goals')) document.getElementById('nav-goals').classList.add('active');

      // render MSI cuando entras
      if(vid === 'view-msi') renderMsi();
      if(vid === 'view-goals') renderGoals();
    };

    const THEME_KEY = "themeMode";
    const THEME_MODES = ["auto", "light", "dark"];

    const getStoredTheme = () => localStorage.getItem(THEME_KEY) || "auto";

    const getSystemPrefersDark = () =>
      window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;

    const getEffectiveTheme = (mode) => {
      if(mode === "dark") return "dark";
      if(mode === "light") return "light";
      return getSystemPrefersDark() ? "dark" : "light";
    };

    const isDarkMode = () => getEffectiveTheme(getStoredTheme()) === "dark";

    const applyThemeMode = (mode) => {
      const root = document.documentElement;
      root.classList.remove("theme-dark", "theme-light");
      if(mode === "dark") root.classList.add("theme-dark");
      if(mode === "light") root.classList.add("theme-light");
      const icon = document.getElementById("theme-icon");
      if(icon){
        icon.className = getEffectiveTheme(mode) === "dark" ? "fas fa-moon" : "fas fa-sun";
      }
      updateChart();
      renderMsi();
    };

    const isProbablyIOS = () => {
      const ua = navigator.userAgent || "";
      return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
    };

    window.toggleThemeMode = () => {
      const current = getStoredTheme();
      const idx = THEME_MODES.indexOf(current);
      const next = THEME_MODES[(idx + 1) % THEME_MODES.length] || "auto";
      localStorage.setItem(THEME_KEY, next);
      applyThemeMode(next);
      showToast(`Tema: ${next === "auto" ? "auto" : next === "dark" ? "oscuro" : "claro"}`, {
        tone: "info",
        duration: 1800
      });
    };

    const initThemeMode = () => {
      const mode = getStoredTheme();
      applyThemeMode(mode);
      const media = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;
      if(media && typeof media.addEventListener === "function"){
        media.addEventListener("change", () => {
          if(getStoredTheme() === "auto") applyThemeMode("auto");
        });
      }
    };

    window.togglePrivacy=()=>{
      privacy=!privacy;
      document.querySelectorAll('.sensitive-data').forEach(el=>{
        privacy ? el.classList.add('blur-sensitive') : el.classList.remove('blur-sensitive');
      });
      document.getElementById('eye-icon').className = privacy ? 'fas fa-eye-slash' : 'fas fa-eye';
    };

    window.manualRefresh = async () => {
      showToast("Actualizando datos...", { tone: "info", duration: 1600 });
      setSyncStatus("syncing", { silent: true });
      await refreshAfterReconnect();
      setSyncStatus("synced", { silent: true });
      updateMonthlyFootprint({ force: true });
    };

    const quickSheet = document.getElementById("quick-sheet");
    const quickBackdrop = document.getElementById("quick-sheet-backdrop");
    const quickAmount = document.getElementById("quick-amount");
    const quickCategory = document.getElementById("quick-category");
    let quickAddPending = false;

    const syncQuickCategories = () => {
      const source = document.getElementById("t-cat");
      if(!source || !quickCategory) return;
      quickCategory.innerHTML = "";
      [...source.options].forEach((opt) => {
        const option = document.createElement("option");
        option.value = opt.value;
        option.textContent = opt.textContent;
        quickCategory.appendChild(option);
      });
      if(quickCategory.options.length) quickCategory.selectedIndex = 0;
    };

    window.openQuickAdd = () => {
      syncQuickCategories();
      if(quickAmount) quickAmount.value = "";
      if(quickSheet) quickSheet.classList.add("is-open");
      if(quickBackdrop) quickBackdrop.classList.add("is-open");
      setTimeout(() => quickAmount?.focus(), 100);
    };

    window.closeQuickAdd = () => {
      if(quickSheet) quickSheet.classList.remove("is-open");
      if(quickBackdrop) quickBackdrop.classList.remove("is-open");
    };

    window.saveQuickAdd = () => {
      const amount = safeNumber(quickAmount?.value);
      if(!amount || amount <= 0){
        showToast("Ingresa un monto v√°lido.", { tone: "warning", duration: 2000 });
        haptic("warn");
        return;
      }
      const form = document.getElementById("form-trans");
      if(!form) return;

      document.getElementById('t-exp').checked = true;
      uiUpdateCats();
      uiToggleMsi();
      uiToggleScope();
      document.getElementById('t-scope-shared').checked = true;
      document.getElementById('t-msi').checked = false;
      uiToggleMsiFields();
      const cardSelect = document.getElementById('t-card');
      if(cardSelect && !cardSelect.value && cardSelect.options.length){
        cardSelect.selectedIndex = 0;
      }
      document.getElementById('t-amount').value = amount;
      const catValue = quickCategory?.value || "";
      if(catValue){
        const catSelect = document.getElementById('t-cat');
        const hasOption = [...catSelect.options].some((opt) => opt.value === catValue);
        if(!hasOption){
          const opt = document.createElement("option");
          opt.value = catValue;
          opt.textContent = catValue;
          catSelect.appendChild(opt);
        }
        catSelect.value = catValue;
      }
      document.getElementById('t-concept').value = catValue ? `Gasto r√°pido: ${catValue}` : "Gasto r√°pido";
      document.getElementById('t-date').value = toLocalYYYYMMDD(new Date());
      quickAddPending = true;
      form.requestSubmit();
    };

    window.handleScopeFilterChange = (value) => {
      if(!FEATURES.coupleMode) return;
      setActiveScopeFilter(value);
      invalidateCategoryAggCacheForOwner(OWNER);
      updateAlerts({ force: true });
      updateMonthlyFootprint({ force: true });
      renderHistory();
      updateChart();
    };

    // Filters
    function initFilters(){
      const chartSel=document.getElementById('chart-month-filter');
      const histSel=document.getElementById('hist-month-filter');
      chartSel.innerHTML=""; histSel.innerHTML='<option value="all">Mes: Todo</option>';
      const now=new Date();
      const monthNames=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
      for(let i=0;i<12;i++){
        const d=new Date(now.getFullYear(), now.getMonth()-i, 1);
        const val=`${d.getFullYear()}-${d.getMonth()}`;
        const txt=`${monthNames[d.getMonth()]} ${d.getFullYear()}`;
        const optC=document.createElement('option'); optC.value=val; optC.text=txt; chartSel.appendChild(optC);
        const optH=document.createElement('option'); optH.value=val; optH.text=txt; histSel.appendChild(optH);
      }
    }
    initFilters();

    // =========================
    // ‚úÖ HIST FILTERS (SMART por cardId)
    // =========================
    function fillHistFilters(){
      const selCard = document.getElementById('hist-card-filter');
      const selCat  = document.getElementById('hist-cat-filter');
      if(!selCard || !selCat) return;

      const prevCard = selCard.value || "all";
      const prevCat  = selCat.value || "all";

      selCard.innerHTML = `<option value="all">Tarjeta: Todas</option>`;
      const sortedCards = [...cards].sort((a,b)=>(a.name||"").localeCompare(b.name||"","es"));
      sortedCards.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent = c.owner==="both" ? `${c.name} (Compartida)` : c.name;
        selCard.appendChild(opt);
      });

      selCat.innerHTML = `<option value="all">Categor√≠a: Todas</option>`;
      const cats = [...new Set(trans.map(t => (t.category || '').trim()).filter(Boolean))]
        .sort((a,b)=>a.localeCompare(b,"es"));
      cats.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c;
        opt.textContent=c;
        selCat.appendChild(opt);
      });

      selCard.value = [...selCard.options].some(o=>o.value===prevCard) ? prevCard : "all";
      selCat.value  = [...selCat.options].some(o=>o.value===prevCat) ? prevCat : "all";
    }

    window.clearHistFilters = ()=>{
      const m = document.getElementById('hist-month-filter');
      const c = document.getElementById('hist-card-filter');
      const g = document.getElementById('hist-cat-filter');
      const s = document.getElementById('search-input');

      if(m) m.value="all";
      if(c) c.value="all";
      if(g) g.value="all";
      if(s) s.value="";

      renderHistory();
    };

    // Seed preset cards (NO sobreescribe tus datos)
    async function seedPresetCards(){
      try{
        setLoaderMsg("Verificando tarjetas precargadas...");
        const existingSnap = await getDocs(query(collection(db,"cards")));
        const existingByOwner={ yair:new Set(), haru:new Set(), both:new Set() };

        existingSnap.forEach(d=>{
          const data=d.data();
          const name=(data.name||"").toLowerCase().trim();
          const owner=(data.owner||"both");
          if(existingByOwner[owner]) existingByOwner[owner].add(name);
        });

        const need=PRESET_CARDS.filter(c=>c.owner===OWNER || c.owner==="both");
        for(const c of need){
          const nm=c.name.toLowerCase();
          const bucket=existingByOwner[c.owner]||new Set();
          if(!bucket.has(nm)){
            await addDoc(collection(db,"cards"), {
              name:c.name,
              owner:c.owner,
              cutDay:1, payDay:1, limit:0, balance:0, payGoal:0
            });
            bucket.add(nm);
          }
        }
      }catch(e){
        console.error("Seed preset cards error:", e);
        showToast("Aviso: no se pudieron verificar/crear tarjetas preset.", { tone: "warning", duration: 3200 });
        haptic("warn");
      }
    }

    // Subscribe helpers
    function resubscribeAll(){
      unsubscribeAll();
      subscribeCards();
      subscribeTrans();
      subscribeGoals();
      resetForm();
      refreshAll({ owner: OWNER, force: true, source: "resubscribe" });
      updateMonthlyFootprint({ force: true });
    }

    // Cards subscribe (front filter)
    function subscribeCards(){
      setLoaderMsg("Cargando tarjetas...");
      const qCards=query(collection(db,"cards"), orderBy("name"));
      let firstSnapshot = true;
      unsubCards = onSnapshot(qCards, (snap)=>{
        if(firstSnapshot){
          markAppReady("cards");
          firstSnapshot = false;
        }
        const tempAll=[];
        snap.forEach(d=>{ const c=d.data(); c.id=d.id; tempAll.push(c); });

        const temp=tempAll.filter(c=>c.owner===OWNER || c.owner==="both");

        cards=[];
        let tDebt=0, tLimit=0;

        const listHome=document.getElementById('home-card-list');
        const listManage=document.getElementById('manage-card-list');
        const select=document.getElementById('t-card');

        listHome.innerHTML=''; listManage.innerHTML='';
        const prevSel=select.value;

        select.innerHTML='';
        const optG_Y=document.createElement('optgroup'); optG_Y.label="Tarjetas de Yair";
        const optG_H=document.createElement('optgroup'); optG_H.label="Tarjetas de Haru";
        const optG_B=document.createElement('optgroup'); optG_B.label="Compartidas";

        temp.sort((a,b)=>(a.name||"").localeCompare(b.name||"","es"));

        temp.forEach(c=>{
          cards.push(c);

          const debt=parseFloat(c.balance||0);
          const limit=parseFloat(c.limit||0);
          tDebt+=debt; tLimit+=limit;

          const today=new Date().getDate();
          const cut=parseInt(c.cutDay||1);
          let diff=parseInt(c.payDay||1)-today; if(diff<0) diff+=30;

          let status={text:'NORMAL', bg:'bg-warning-light'};
          if(diff<=5) status={text:`VENCE EN ${diff} D√çAS`, bg:'bg-danger-light'};
          else if(today>=cut && today<=cut+5) status={text:'MEJOR OPCI√ìN', bg:'bg-success-light'};

          const hasAlert = hasUpcomingAlert(c);
          listHome.innerHTML += `
            <div class="list-item">
              <div>
                <div class="fw-bold mb-1">
                  ${c.name}
                  ${hasAlert ? '<span class="badge-status bg-danger-light ms-2">ALERTA</span>' : ''}
                </div>
                <span class="badge-status ${status.bg}">${status.text}</span>
              </div>
              <div class="text-end">
                <div class="fw-bold text-danger sensitive-data">${formatMoney(debt)}</div>
                <small class="text-success sensitive-data">Disp: ${formatMoney(limit-debt)}</small>
              </div>
            </div>
          `;

          listManage.innerHTML += `
            <div class="list-item" onclick="editCard('${c.id}')">
              <div class="fw-bold">
                ${c.name}
                ${hasAlert ? '<span class="badge-status bg-danger-light ms-2">ALERTA</span>' : ''}
              </div>
              <i class="fas fa-chevron-right text-muted"></i>
            </div>
          `;

          const opt=document.createElement("option");
          opt.value=c.id;
          opt.textContent=c.name;

          if(c.owner==="yair") optG_Y.appendChild(opt);
          else if(c.owner==="haru") optG_H.appendChild(opt);
          else optG_B.appendChild(opt);
        });

        if(optG_Y.children.length) select.appendChild(optG_Y);
        if(optG_H.children.length) select.appendChild(optG_H);
        if(optG_B.children.length) select.appendChild(optG_B);

        if(prevSel) select.value=prevSel;
        if(!select.value && select.options.length) select.selectedIndex=0;

        document.getElementById('total-debt').innerText=formatMoney(tDebt);
        document.getElementById('total-avail').innerText=formatMoney(tLimit-tDebt);

        const ratio = tLimit>0 ? (tDebt/tLimit)*100 : 0;
        const uBar=document.getElementById('util-bar');
        uBar.style.width=`${Math.min(ratio,100)}%`;
        document.getElementById('util-text').innerText=`${ratio.toFixed(1)}%`;
        if(ratio<30) uBar.className='progress-bar bg-success';
        else if(ratio<50) uBar.className='progress-bar bg-warning';
        else uBar.className='progress-bar bg-danger';

        if(privacy) togglePrivacy();
        updateSmartPick();
        updatePaymentMonitor();
        updateAlerts();
        fillHistFilters();

      }, (err)=>{
        console.error("Cards snapshot error:", err);
        showStartupError(`Error leyendo tarjetas: ${getFirestoreErrorMessage(err)}`);
      });
    }

    // Trans subscribe (owner)
    function subscribeTrans(){
      setLoaderMsg("Cargando movimientos...");
      const qTrans=query(collection(db,"expenses"), where("owner","==",OWNER), orderBy("date","desc"));
      let firstSnapshot = true;
      unsubTrans = onSnapshot(qTrans, { includeMetadataChanges: true }, (snap)=>{
        if(firstSnapshot){
          markAppReady("expenses");
          firstSnapshot = false;
        }
        trans=[];
        snap.forEach(d=>{
          const t=d.data();
          t.id=d.id;
          t.scope = normalizeScope(t.scope);
          trans.push(t);
        });

        handlePendingWrites(snap.metadata.hasPendingWrites);
        fillHistFilters();
        emit("DATA_LOADED", { owner: OWNER, count: trans.length });

        if(privacy) togglePrivacy();
      }, (err)=>{
        console.error("Expenses snapshot error:", err);
        showStartupError(`Error leyendo movimientos: ${getFirestoreErrorMessage(err)}`);
      });
    }

    // Goals subscribe + render
    const GOAL_SORT_STEP = 10;
    const getGoalPriorityValue = (priority) =>
      (priority === null || priority === undefined || priority === "") ? 99 : Number(priority);
    const getGoalSortOrderValue = (sortOrder) =>
      Number.isFinite(sortOrder) ? sortOrder : Number.POSITIVE_INFINITY;
    const getGoalUpdatedAtValue = (updatedAt) => {
      if(!updatedAt) return 0;
      if(updatedAt.toDate) return updatedAt.toDate().getTime();
      const parsed = new Date(updatedAt);
      return Number.isFinite(parsed.getTime()) ? parsed.getTime() : 0;
    };

    const sortGoalsList = (list) => [...list].sort((a,b)=>{
      const pA = getGoalPriorityValue(a.priority);
      const pB = getGoalPriorityValue(b.priority);
      if(pA !== pB) return pA - pB;
      const sA = getGoalSortOrderValue(a.sortOrder);
      const sB = getGoalSortOrderValue(b.sortOrder);
      if(sA !== sB) return sA - sB;
      const uA = getGoalUpdatedAtValue(a.updatedAt);
      const uB = getGoalUpdatedAtValue(b.updatedAt);
      return uB - uA;
    });

    const toLocalYYYYMMDD = (date = new Date()) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    };

    const parseLocalYYYYMMDDToDate = (value, { hour = 12 } = {}) => {
      if(!value) return null;
      const [year, month, day] = value.split("-").map(Number);
      if(!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;
      return new Date(year, month - 1, day, hour, 0, 0, 0);
    };

    const getLocalDateInputValue = (date = new Date()) => toLocalYYYYMMDD(date);

    const formatGoalOwner = (owner) => owner === "haru" ? "Haru" : "Yair";

    const buildGoalsQuery = () => {
      const whereFields = [
        { field: "status", op: "==", value: "active" }
      ];
      const orderByFields = [
        { field: "priority", direction: "asc" },
        { field: "sortOrder", direction: "asc" },
        { field: "updatedAt", direction: "desc" }
      ];
      const q = query(
        collection(db,"goals"),
        where("status","==","active"),
        orderBy("priority","asc"),
        orderBy("sortOrder","asc"),
        orderBy("updatedAt","desc")
      );
      const debugInfo = { whereFields, orderByFields };
      console.info("[goals query]", debugInfo);
      return { q, debugInfo };
    };

    function retryGoalsSubscription(){
      subscribeGoals({ source: "retry" });
    }

    function subscribeGoals({ source = "initial" } = {}){
      if(unsubGoals){
        unsubGoals();
        unsubGoals = null;
      }
      goalsLoading = true;
      goalsError = null;
      renderGoals();
      hideMissingIndexBanner();
      const { q: qGoals, debugInfo } = buildGoalsQuery();
      unsubGoals = onSnapshot(qGoals, async(snap)=>{
        const temp=[];
        snap.forEach(d=>{
          const g=d.data();
          g.id=d.id;
          temp.push(g);
        });

        goalsLoading = false;
        goalsError = null;
        hideMissingIndexBanner();
        let sorted = sortGoalsList(temp);
        const batch = writeBatch(db);
        let needsUpdate = false;

        sorted.forEach((goal, index)=>{
          if(!Number.isFinite(goal.sortOrder)){
            const newOrder = index * GOAL_SORT_STEP;
            goal.sortOrder = newOrder;
            batch.update(doc(db,"goals",goal.id), { sortOrder: newOrder, updatedAt: serverTimestamp() });
            needsUpdate = true;
          }
        });

        goals = sortGoalsList(sorted);
        renderGoals();

        if(needsUpdate){
          try{
            await batch.commit();
          }catch(e){
            console.error("Goals sortOrder update error:", e);
          }
        }
      }, (err)=>{
        console.error("Goals snapshot error:", err);
        goalsLoading = false;
        const isMissing = isMissingIndexError(err);
        const link = extractIndexLink(err?.message || "");
        goalsError = {
          type: isMissing ? "missing_index" : "generic",
          link,
          message: err?.message || "",
          debugInfo
        };
        if(isMissing){
          renderGoalsMissingIndexBanner({ link, debugInfo });
        }else{
          hideMissingIndexBanner();
          const now = Date.now();
          if(now - goalsLastErrorToastAt > 4000){
            showToast("No se pudieron cargar las metas. Intenta m√°s tarde.", { tone: "warning", duration: 2600 });
            goalsLastErrorToastAt = now;
          }
        }
        renderGoals();
      });
    }

    function renderGoals(){
      const listEl = document.getElementById('goals-list');
      if(!listEl) return;
      if(goalsLoading){
        listEl.innerHTML = '<div class="text-muted small p-3">Cargando metas...</div>';
        return;
      }
      if(goalsError?.type === "missing_index"){
        listEl.innerHTML = '<div class="text-muted small p-3">No se pudieron cargar metas por √≠ndice faltante.</div>';
        return;
      }
      if(goalsError){
        listEl.innerHTML = '<div class="text-muted small p-3">No se pudieron cargar las metas.</div>';
        return;
      }
      if(!goals.length){
        listEl.innerHTML = '<div class="text-center text-muted small p-3">No hay metas activas.</div>';
        return;
      }
      const sorted = sortGoalsList(goals);
      listEl.innerHTML = '';
      sorted.forEach((goal)=>{
        const current = Number(goal.savedAmount ?? goal.currentAmount ?? 0);
        const target = Number(goal.targetAmount ?? 0);
        const progress = target > 0 ? Math.min((current / target) * 100, 100) : 0;
        const remaining = Math.max(target - current, 0);
        const priorityValue = (goal.priority === null || goal.priority === undefined || goal.priority === "")
          ? ""
          : String(goal.priority);

        listEl.innerHTML += `
          <div class="goal-card" data-goal-id="${goal.id}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="fw-bold">${goal.name || "Meta sin nombre"}</div>
              <div class="d-flex align-items-center gap-2">
                <div class="goal-move-controls">
                  <button class="goal-move-btn" type="button" data-move="up" data-id="${goal.id}" aria-label="Mover arriba">‚Üë</button>
                  <button class="goal-move-btn" type="button" data-move="down" data-id="${goal.id}" aria-label="Mover abajo">‚Üì</button>
                </div>
                <div class="goal-handle" role="button" aria-label="Reordenar meta" data-id="${goal.id}">‚â°</div>
              </div>
            </div>
            <div class="progress mb-2" style="height:10px;background-color:var(--bg-body);">
              <div class="progress-bar bg-success" role="progressbar" style="width:${progress}%"></div>
            </div>
            <div class="goal-metrics mb-2">
              <span>Ahorrado <strong>${formatMoney(current)}</strong></span>
              <span>Objetivo <strong>${formatMoney(target)}</strong></span>
              <span>Faltan <strong>${formatMoney(remaining)}</strong></span>
            </div>
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
              <div class="small text-muted">Prioridad</div>
              <select class="form-select form-select-sm w-auto goal-priority-select" data-id="${goal.id}">
                <option value="" ${priorityValue === "" ? "selected" : ""}>‚Äî</option>
                <option value="1" ${priorityValue === "1" ? "selected" : ""}>1</option>
                <option value="2" ${priorityValue === "2" ? "selected" : ""}>2</option>
                <option value="3" ${priorityValue === "3" ? "selected" : ""}>3</option>
              </select>
            </div>
            <div class="goal-actions">
              <button class="btn btn-outline-primary btn-sm goal-action-add" type="button" data-id="${goal.id}">
                <i class="fas fa-piggy-bank me-1"></i> Aportar
              </button>
              <button class="btn btn-light btn-sm goal-action-view" type="button" data-id="${goal.id}">
                <i class="fas fa-eye me-1"></i> Ver
              </button>
            </div>
          </div>
        `;
      });
    }

    async function loadGoalContributions(goalId){
      const listEl = document.getElementById("goal-contrib-list");
      if(listEl) listEl.innerHTML = '<div class="text-muted small">Cargando aportes...</div>';
      try{
        const qContrib = query(
          collection(db, "goal_contributions"),
          where("goalId", "==", goalId),
          orderBy("date", "desc"),
          limit(20)
        );
        const snap = await getDocs(qContrib);
        if(!listEl) return;
        if(snap.empty){
          listEl.innerHTML = '<div class="text-muted small">No hay aportes todav√≠a.</div>';
          return;
        }
        listEl.innerHTML = "";
        snap.forEach((docSnap)=>{
          const contrib = docSnap.data();
          const amount = Number(contrib.amount || 0);
          const date = contrib.date?.toDate ? contrib.date.toDate() : null;
          const dateLabel = date ? date.toLocaleDateString() : "Sin fecha";
          const ownerLabel = formatGoalOwner(contrib.owner);
          const note = contrib.note ? ` ¬∑ ${contrib.note}` : "";
          listEl.innerHTML += `
            <div class="goal-contrib-item mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-bold">${formatMoney(amount)}</div>
                <div class="text-muted small">${dateLabel}</div>
              </div>
              <div class="text-muted small">${ownerLabel}${note}</div>
            </div>
          `;
        });
      }catch(err){
        console.error("Goal contributions error:", err);
        const isMissing = isMissingIndexError(err);
        const link = extractIndexLink(err?.message || "");
        if(isMissing){
          renderMissingIndexBanner({ module: "Metas", link });
          if(listEl){
            listEl.innerHTML = '<div class="text-muted small">No se pudieron cargar aportes por √≠ndice faltante.</div>';
          }
        }else if(listEl){
          listEl.innerHTML = '<div class="text-muted small">No se pudieron cargar los aportes.</div>';
        }
      }
    }

    async function renderGoalDetail(goalId){
      const detailEl = document.getElementById("goal-detail-body");
      if(!detailEl) return;
      let goal = goals.find(g=>g.id===goalId) || null;
      if(!goal){
        const goalSnap = await getDoc(doc(db, "goals", goalId));
        if(goalSnap.exists()) goal = goalSnap.data();
      }
      if(!goal){
        detailEl.innerHTML = '<div class="text-muted small">No se encontr√≥ la meta.</div>';
        return;
      }
      const titleEl = document.getElementById("goal-detail-title");
      if(titleEl){
        titleEl.textContent = goal?.name ? `Meta: ${goal.name}` : "Detalle de meta";
      }
      const current = Number(goal.savedAmount ?? goal.currentAmount ?? 0);
      const target = Number(goal.targetAmount ?? 0);
      const progress = target > 0 ? Math.min((current / target) * 100, 100) : 0;
      const remaining = Math.max(target - current, 0);
      const priorityLabel = goal.priority ? `Prioridad ${goal.priority}` : "Sin prioridad";

      detailEl.innerHTML = `
        <div class="mb-3">
          <div class="goal-detail-meta mb-2">
            <span>${priorityLabel}</span>
            <span>Ahorrado <strong>${formatMoney(current)}</strong></span>
            <span>Objetivo <strong>${formatMoney(target)}</strong></span>
            <span>Faltan <strong>${formatMoney(remaining)}</strong></span>
          </div>
          <div class="progress" style="height:10px;background-color:var(--bg-body);">
            <div class="progress-bar bg-success" role="progressbar" style="width:${progress}%"></div>
          </div>
        </div>
        <div class="d-flex gap-2 mb-3">
          <button class="btn btn-outline-primary flex-fill" type="button" id="goal-detail-add" data-id="${goalId}">
            <i class="fas fa-piggy-bank me-1"></i> Aportar
          </button>
          <button class="btn btn-outline-secondary flex-fill" type="button" id="goal-detail-archive" data-id="${goalId}">
            <i class="fas fa-box-archive me-1"></i> Archivar meta
          </button>
        </div>
        <div class="mb-2 fw-bold">Aportes recientes</div>
        <div id="goal-contrib-list"></div>
      `;

      const addBtn = document.getElementById("goal-detail-add");
      if(addBtn){
        addBtn.addEventListener("click", ()=>{
          openGoalContribution(goalId);
        });
      }
      const archiveBtn = document.getElementById("goal-detail-archive");
      if(archiveBtn){
        archiveBtn.addEventListener("click", async()=>{
          if(!confirm("¬øArchivar esta meta?")) return;
          try{
            await updateDoc(doc(db,"goals", goalId), { status: "archived", updatedAt: serverTimestamp() });
            showToast("Meta archivada.", { tone: "info", duration: 2200 });
            if(goalDetailModal) goalDetailModal.hide();
          }catch(err){
            console.error("Archive goal error:", err);
            showToast("No se pudo archivar la meta.", { tone: "warning", duration: 2400 });
          }
        });
      }

      await loadGoalContributions(goalId);
    }

    function openGoalDetail(goalId){
      activeGoalDetailId = goalId;
      if(!goalDetailModal){
        goalDetailModal = new bootstrap.Modal(document.getElementById('modalGoalDetail'));
      }
      const titleEl = document.getElementById("goal-detail-title");
      if(titleEl){
        const goal = goals.find(g=>g.id===goalId);
        titleEl.textContent = goal?.name ? `Meta: ${goal.name}` : "Detalle de meta";
      }
      const detailEl = document.getElementById("goal-detail-body");
      if(detailEl) detailEl.innerHTML = '<div class="text-muted small">Cargando meta...</div>';
      goalDetailModal.show();
      renderGoalDetail(goalId);
    }

    function openGoalContribution(goalId){
      const idInput = document.getElementById("goal-contribution-id");
      const amountInput = document.getElementById("goal-contribution-amount");
      const ownerInput = document.getElementById("goal-contribution-owner");
      const dateInput = document.getElementById("goal-contribution-date");
      const noteInput = document.getElementById("goal-contribution-note");
      if(idInput) idInput.value = goalId;
      if(amountInput) amountInput.value = "";
      if(ownerInput) ownerInput.value = OWNER || "yair";
      if(dateInput) dateInput.value = getLocalDateInputValue();
      if(noteInput) noteInput.value = "";
      if(!goalContributionModal){
        goalContributionModal = new bootstrap.Modal(document.getElementById('modalGoalContribution'));
      }
      goalContributionModal.show();
    }

    async function persistGoalOrder(orderedGoals){
      const batch = writeBatch(db);
      orderedGoals.forEach((goal, index)=>{
        const newOrder = index * GOAL_SORT_STEP;
        goal.sortOrder = newOrder;
        batch.update(doc(db,"goals", goal.id), {
          sortOrder: newOrder,
          updatedAt: serverTimestamp()
        });
      });
      try{
        await batch.commit();
      }catch(e){
        console.error("Goals reorder error:", e);
        showToast("No se pudo guardar el orden de metas.", { tone: "warning", duration: 2600 });
      }
    }

    function getGoalsFromDom(){
      const listEl = document.getElementById('goals-list');
      if(!listEl) return [];
      return Array.from(listEl.querySelectorAll('.goal-card')).map((card)=>{
        const id = card.getAttribute('data-goal-id');
        return goals.find(g=>g.id===id);
      }).filter(Boolean);
    }

    function moveGoalByStep(goalId, direction){
      const ordered = sortGoalsList(goals);
      const index = ordered.findIndex(g=>g.id===goalId);
      if(index === -1) return;
      const targetIndex = direction === "up" ? index - 1 : index + 1;
      if(targetIndex < 0 || targetIndex >= ordered.length) return;
      const temp = ordered[index];
      ordered[index] = ordered[targetIndex];
      ordered[targetIndex] = temp;
      goals = ordered;
      renderGoals();
      persistGoalOrder(ordered);
    }

    function setupGoalEvents(){
      const listEl = document.getElementById('goals-list');
      if(!listEl) return;

      listEl.addEventListener('change', async(e)=>{
        const target = e.target;
        if(!(target instanceof HTMLSelectElement)) return;
        if(!target.classList.contains('goal-priority-select')) return;
        const id = target.getAttribute('data-id');
        const value = target.value === "" ? null : Number(target.value);
        const goal = goals.find(g=>g.id===id);
        if(goal) goal.priority = value;
        renderGoals();
        try{
          await updateDoc(doc(db,"goals", id), { priority: value, updatedAt: serverTimestamp() });
        }catch(err){
          console.error("Update priority error:", err);
          showToast("No se pudo actualizar la prioridad.", { tone: "warning", duration: 2400 });
        }
      });

      listEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('.goal-move-btn');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const direction = btn.getAttribute('data-move');
        moveGoalByStep(id, direction);
      });

      listEl.addEventListener('click', (e)=>{
        const addBtn = e.target.closest('.goal-action-add');
        if(addBtn){
          const id = addBtn.getAttribute('data-id');
          openGoalContribution(id);
          return;
        }
        const viewBtn = e.target.closest('.goal-action-view');
        if(viewBtn){
          const id = viewBtn.getAttribute('data-id');
          openGoalDetail(id);
        }
      });

      let dragState = null;

      listEl.addEventListener('pointerdown', (e)=>{
        const handle = e.target.closest('.goal-handle');
        if(!handle) return;
        if(!window.PointerEvent) return;
        const id = handle.getAttribute('data-id');
        const item = listEl.querySelector(`.goal-card[data-goal-id="${id}"]`);
        if(!item) return;

        const rect = item.getBoundingClientRect();
        const placeholder = document.createElement('div');
        placeholder.className = 'goal-placeholder';
        placeholder.style.height = `${rect.height}px`;
        item.parentNode.insertBefore(placeholder, item.nextSibling);

        dragState = {
          item,
          placeholder,
          offsetY: e.clientY - rect.top,
          pointerId: e.pointerId
        };

        item.classList.add('dragging');
        item.style.width = `${rect.width}px`;
        item.style.position = 'absolute';
        item.style.left = `${rect.left}px`;
        item.style.top = `${rect.top + window.scrollY}px`;
        item.style.zIndex = 2000;
        document.body.appendChild(item);
        document.body.style.userSelect = 'none';
        handle.setPointerCapture(e.pointerId);
      });

      listEl.addEventListener('pointermove', (e)=>{
        if(!dragState) return;
        const { item, placeholder, offsetY } = dragState;
        item.style.top = `${e.clientY + window.scrollY - offsetY}px`;

        const target = document.elementFromPoint(e.clientX, e.clientY);
        const card = target?.closest('.goal-card');
        if(card && card !== item){
          const cardRect = card.getBoundingClientRect();
          const after = e.clientY > cardRect.top + cardRect.height / 2;
          if(after){
            card.parentNode.insertBefore(placeholder, card.nextSibling);
          }else{
            card.parentNode.insertBefore(placeholder, card);
          }
        }
      });

      const finishDrag = async()=>{
        if(!dragState) return;
        const { item, placeholder } = dragState;
        item.classList.remove('dragging');
        item.style.position = '';
        item.style.left = '';
        item.style.top = '';
        item.style.width = '';
        item.style.zIndex = '';
        document.body.style.userSelect = '';

        placeholder.parentNode.insertBefore(item, placeholder);
        placeholder.remove();

        const ordered = getGoalsFromDom();
        goals = ordered;
        await persistGoalOrder(ordered);
        renderGoals();
        dragState = null;
      };

      listEl.addEventListener('pointerup', finishDrag);
      listEl.addEventListener('pointercancel', finishDrag);
    }

    // Monitor pagos + smart pick
    function updatePaymentMonitor(){
      const list=document.getElementById('payment-monitor-list');
      list.innerHTML='';
      let hasGoals=false;

      cards.forEach(c=>{
        const goal=parseFloat(c.payGoal||0);
        if(goal<=0) return;

        hasGoals=true;
        const today=new Date();
        const cutDay=parseInt(c.cutDay||1);

        let cycleStart=new Date();
        if(today.getDate()<cutDay) cycleStart.setMonth(cycleStart.getMonth()-1);
        cycleStart.setDate(cutDay); cycleStart.setHours(0,0,0,0);

        let paid=0;
        trans.forEach(t=>{
          if(t.cardId===c.id && t.type==='payment' && t.date.toDate()>cycleStart) paid += t.amount;
        });

        const pct=Math.min((paid/goal)*100,100);
        const remaining=Math.max(goal-paid,0);
        let color = pct>50 ? 'warning' : 'danger';
        if(pct>=100) color='success';

        list.innerHTML += `
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="small fw-bold">${c.name}</span>
              <span class="small fw-bold text-${color} sensitive-data">${pct>=100 ? '¬°CUBIERTO!' : 'Faltan ' + formatMoney(remaining)}</span>
            </div>
            <div class="progress" style="height:12px;background-color:var(--bg-body);">
              <div class="progress-bar bg-${color}" role="progressbar" style="width:${pct}%"></div>
            </div>
          </div>
        `;
      });

      if(!hasGoals) list.innerHTML = '<div class="text-center text-muted small p-3">Configura el "Pago para no generar intereses" al editar una tarjeta.</div>';
      if(privacy) togglePrivacy();
    }

    function updateSmartPick(){
      const today=new Date().getDate(); let best=null, min=999;
      cards.forEach(c=>{
        let d=today-parseInt(c.cutDay||1);
        if(d>=0 && d<min){ min=d; best=c; }
      });
      const area=document.getElementById('smart-area');
      if(best && min<=7){
        area.classList.remove('d-none');
        document.getElementById('smart-name').innerText=best.name;
        document.getElementById('smart-msg').innerText=`Cort√≥ hace ${min} d√≠as. √ösala para m√°ximo financiamiento.`;
      }else area.classList.add('d-none');
    }

    // =========================
    // ‚úÖ Alertas inteligentes (0-2 d√≠as)
    // =========================
    function getLastDayOfMonth(year, month){
      return new Date(year, month + 1, 0).getDate();
    }

    function getNextOccurrence(baseDate, targetDay){
      const todayStart = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
      const currentLast = getLastDayOfMonth(todayStart.getFullYear(), todayStart.getMonth());
      const safeDay = Math.min(parseInt(targetDay || 1, 10), currentLast);
      let candidate = new Date(todayStart.getFullYear(), todayStart.getMonth(), safeDay);

      if(candidate < todayStart){
        const nextMonth = new Date(todayStart.getFullYear(), todayStart.getMonth() + 1, 1);
        const nextLast = getLastDayOfMonth(nextMonth.getFullYear(), nextMonth.getMonth());
        const safeNext = Math.min(parseInt(targetDay || 1, 10), nextLast);
        candidate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), safeNext);
      }

      candidate.setHours(0, 0, 0, 0);
      return candidate;
    }

    function daysUntil(targetDate, baseDate){
      const start = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
      const diff = targetDate - start;
      return Math.max(0, Math.ceil(diff / 86400000));
    }

    function pluralize(value, singular, plural){
      return value === 1 ? singular : plural;
    }

    function buildAlertTitle(diff){
      if(diff === 0) return "Vence hoy";
      if(diff === 1) return "Ma√±ana vence";
      return `Vence en ${diff} d√≠as`;
    }

    function buildAlertText(diff, now){
      if(diff === 0){
        const hoursLeft = Math.max(0, 24 - now.getHours());
        return `Faltan ${hoursLeft} ${pluralize(hoursLeft, "hora", "horas")}. Evita intereses pagando hoy.`;
      }
      return `Faltan ${diff} ${pluralize(diff, "d√≠a", "d√≠as")}. Evita intereses pagando hoy.`;
    }

    function getCardAlerts(card, now){
      const alerts = [];
      const payDay = parseInt(card.payDay || 1, 10);
      const cutDay = parseInt(card.cutDay || 1, 10);

      const payDate = getNextOccurrence(now, payDay);
      const cutDate = getNextOccurrence(now, cutDay);
      const payDiff = daysUntil(payDate, now);
      const cutDiff = daysUntil(cutDate, now);

      if(payDiff <= 2){
        alerts.push({
          type: "pay",
          diff: payDiff,
          title: buildAlertTitle(payDiff),
          text: buildAlertText(payDiff, now)
        });
      }

      if(cutDiff <= 2){
        alerts.push({
          type: "cut",
          diff: cutDiff,
          title: buildAlertTitle(cutDiff),
          text: buildAlertText(cutDiff, now)
        });
      }

      return alerts;
    }

    function hasUpcomingAlert(card){
      const now = new Date();
      return getCardAlerts(card, now).length > 0;
    }

    function getMonthKey(date){
      const d = toDate(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    }

    function getDateKey(date){
      const d = toDate(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
    }

    function isAlertDismissed(key){
      if(!key) return false;
      return localStorage.getItem(key) === "1";
    }

    async function loadExpensesMonthOffset(owner, offset, { force = false } = {}){
      const now = new Date();
      const target = new Date(now.getFullYear(), now.getMonth() - offset, 1);
      return loadExpensesByPeriod(owner, {
        start: startOfMonth(target),
        end: endOfMonth(target),
        periodKey: `month-offset-${offset}`,
        force
      });
    }

    function buildWeekFallback(expenses = [], now = new Date()){
      const onlyExpenses = (expenses || [])
        .filter((t) => t?.type === "expense")
        .map((t) => ({ ...t, date: toDate(t?.date) }));
      const start = startOfWeek(now);
      const end = endOfWeek(now);
      return onlyExpenses.filter((t) => t.date >= start && t.date <= end);
    }

    async function computeAlerts(owner, { force = false } = {}){
      const o = getActiveOwner(owner);
      const now = new Date();
      const scopeFilter = getActiveScopeFilter();
      const useLoader = typeof window.loadPeriodData === "function";
      const periodData = useLoader
        ? await window.loadPeriodData(o, { force })
        : buildPeriodDataFallback(trans);
      const scopedPeriodData = applyScopeFilterToPeriodData(periodData, scopeFilter);

      const monthCurrentTotal = sumExpenses(scopedPeriodData?.month?.current || []);
      const weekCurrentTotal = sumExpenses(
        applyScopeFilter(scopedPeriodData?.week?.current || buildWeekFallback(trans, now), scopeFilter)
      );

      const prevMonthsExpenses = await Promise.all(
        [1, 2, 3].map((offset) => loadExpensesMonthOffset(o, offset, { force }))
      );
      const prevMonthsTotals = prevMonthsExpenses.map((list) => sumExpenses(applyScopeFilter(list, scopeFilter)));
      const avgPrevMonths = prevMonthsTotals.length
        ? prevMonthsTotals.reduce((acc, val) => acc + val, 0) / prevMonthsTotals.length
        : 0;

      const startPrevWeeks = startOfWeek(now);
      const endPrevWeeks = new Date(startPrevWeeks.getTime() - 1);
      endPrevWeeks.setHours(23, 59, 59, 999);
      const startPrevWeeksRange = new Date(endPrevWeeks);
      startPrevWeeksRange.setDate(endPrevWeeks.getDate() - 27);
      startPrevWeeksRange.setHours(0, 0, 0, 0);

      const prevWeeksExpenses = await loadExpensesByPeriod(o, {
        start: startPrevWeeksRange,
        end: endPrevWeeks,
        periodKey: "weeks-previous-4",
        force
      });
      const avgPrevWeeks = sumExpenses(applyScopeFilter(prevWeeksExpenses, scopeFilter)) / 4;

      const alerts = [];

      if(avgPrevMonths > 0 && monthCurrentTotal > avgPrevMonths * 1.2){
        const diff = monthCurrentTotal - avgPrevMonths;
        const pct = Math.round(((monthCurrentTotal - avgPrevMonths) / avgPrevMonths) * 100);
        const periodKey = getMonthKey(now);
        const dismissKey = `alert_gasto_alto_mes_${periodKey}`;
        if(!isAlertDismissed(dismissKey)){
          alerts.push({
            id: `month-high-${periodKey}`,
            kind: "monthly-high",
            severity: "warning",
            title: "Gasto alto este mes",
            message: `Este mes van +${formatCurrency(diff)} arriba de lo normal (+${pct}%).`,
            sortValue: 5,
            periodKey,
            dismissKey
          });
        }
      }

      if(avgPrevWeeks > 0 && weekCurrentTotal > avgPrevWeeks * 1.2){
        const diff = weekCurrentTotal - avgPrevWeeks;
        const pct = Math.round(((weekCurrentTotal - avgPrevWeeks) / avgPrevWeeks) * 100);
        const weekKey = getDateKey(startOfWeek(now));
        const dismissKey = `alert_gasto_alto_semana_${weekKey}`;
        if(!isAlertDismissed(dismissKey)){
          alerts.push({
            id: `week-high-${weekKey}`,
            kind: "weekly-high",
            severity: "warning",
            title: "Gasto alto esta semana",
            message: `Esta semana van +${formatCurrency(diff)} arriba de lo normal (+${pct}%).`,
            sortValue: 6,
            periodKey: weekKey,
            dismissKey
          });
        }
      }

      return alerts;
    }

    let activeAlerts = [];

    window.dismissAlert = (id) => {
      const alert = activeAlerts.find((item) => item.id === id);
      if(!alert || !alert.dismissKey) return;
      localStorage.setItem(alert.dismissKey, "1");
      activeAlerts = activeAlerts.filter((item) => item.id !== id);
      renderAlerts(activeAlerts);
    };

    function renderAlerts(alerts = []){
      const section = document.getElementById('alerts-section');
      const list = document.getElementById('alerts-list');
      if(!section || !list) return;

      activeAlerts = alerts;
      list.classList.remove("is-loading");

      if(!alerts.length){
        section.classList.add('d-none');
        list.innerHTML = '<small class="text-muted">Sin alertas por ahora.</small>';
        return;
      }

      list.innerHTML = alerts.map(alert => `
        <div class="alert-item">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-content">
            <div class="fw-bold">${alert.title}</div>
            ${alert.meta ? `<div class="text-muted small">${alert.meta}</div>` : ""}
            <div class="small">${alert.message}</div>
          </div>
          ${alert.dismissKey ? `
            <div class="alert-actions">
              <button class="btn btn-light btn-sm" onclick="dismissAlert('${alert.id}')">Entendido</button>
            </div>
          ` : ""}
        </div>
      `).join('');

      section.classList.remove('d-none');
      animateIn(section);
    }

    async function updateAlerts({ force = false } = {}){
      const section = document.getElementById('alerts-section');
      const list = document.getElementById('alerts-list');
      if(!section || !list) return;
      if(!FEATURES.alerts){
        section.classList.add("d-none");
        return;
      }

      section.classList.remove("d-none");
      list.classList.add("is-loading");
      list.innerHTML = `
        <div class="alert-item">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-content" style="flex:1;">
            <div class="skeleton skeleton-line" style="width:55%;"></div>
            <div class="skeleton skeleton-line" style="width:80%;"></div>
          </div>
        </div>
      `;

      const now = new Date();
      const alerts = await computeAlerts(getActiveOwner(), { force });

      cards.forEach(card => {
        const cardAlerts = getCardAlerts(card, now);
        cardAlerts.forEach(alert => {
          const typeLabel = alert.type === "pay" ? "Pago" : "Corte";
          alerts.push({
            id: `card-${card.id}-${alert.type}-${alert.diff}`,
            kind: "card",
            severity: "info",
            title: alert.title,
            message: alert.text,
            meta: `${card.name} ¬∑ ${typeLabel}`,
            sortValue: alert.diff
          });
        });
      });

      const cardAlertCount = alerts.filter(alert => alert.kind === "card").length;
      alerts.sort((a, b) => {
        const sortA = Number.isFinite(a.sortValue) ? a.sortValue : 99;
        const sortB = Number.isFinite(b.sortValue) ? b.sortValue : 99;
        if(sortA !== sortB) return sortA - sortB;
        return a.title.localeCompare(b.title, "es");
      });
      const badge = section.querySelector('.badge-status');
      if(badge) badge.textContent = cardAlertCount ? "0-2 d√≠as" : "Avisos";
      renderAlerts(alerts);
    }

    // =========================
    // ‚úÖ MSI: helpers + render
    // =========================
    function monthsBetween(a, b){
      // a,b = Date
      const ay=a.getFullYear(), am=a.getMonth();
      const by=b.getFullYear(), bm=b.getMonth();
      let diff=(by-ay)*12 + (bm-am);

      // si el d√≠a del mes a√∫n no llega, no contamos el mes completo
      if(b.getDate() < a.getDate()) diff -= 1;
      return Math.max(0, diff);
    }

    function getMsiItems(){
      const now=new Date();
      const items = trans
        .filter(t => t.type === "expense" && t.isMsi === true && t.msiMonths && t.msiStart)
        .map(t => {
          const start = t.msiStart?.toDate ? t.msiStart.toDate() : new Date(t.msiStart);
          const totalMonths = parseInt(t.msiMonths, 10) || 0;
          const passed = monthsBetween(start, now);
          const remaining = Math.max(totalMonths - passed, 0);
          const monthly = (Number(t.amount||0) / Math.max(totalMonths,1));

          return {
            ...t,
            start,
            totalMonths,
            passed,
            remaining,
            monthly
          };
        })
        .sort((a,b)=> b.remaining - a.remaining);

      const mode = document.getElementById('msi-filter')?.value || 'active';

      if(mode === 'active') return items.filter(x => x.remaining > 0);
      if(mode === 'done') return items.filter(x => x.remaining === 0);
      return items;
    }

    window.renderMsi = () => {
      const list = document.getElementById('msi-list');
      const count = document.getElementById('msi-count');
      const canvas = document.getElementById('msiChart');
      const noData = document.getElementById('msi-no-data');

      if(!list || !canvas || !noData) return;

      const items = getMsiItems();
      count.textContent = `${items.length} compras`;

      // List
      if(items.length === 0){
        list.innerHTML = '<div class="text-center text-muted small p-3">No hay compras MSI en este filtro.</div>';
      }else{
        list.innerHTML = '';
        items.forEach(t => {
          const pct = t.totalMonths > 0 ? Math.min((t.passed / t.totalMonths) * 100, 100) : 0;
          const color = (t.remaining === 0) ? 'success' : (t.remaining <= 2 ? 'warning' : 'primary');

          list.innerHTML += `
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">${t.concept || 'Compra MSI'}</div>
                  <small class="text-muted">${t.cardName || ''} ‚Ä¢ Inicio: ${t.start.toLocaleDateString()} ‚Ä¢ ${t.totalMonths} MSI</small>
                </div>
                <div class="text-end">
                  <div class="fw-black sensitive-data">${t.remaining === 0 ? '‚úÖ Liquidada' : `${t.remaining} meses`}</div>
                  <small class="text-muted sensitive-data">${formatMoney(t.monthly)}/mes</small>
                </div>
              </div>
              <div class="progress mt-2" style="height:12px;background-color:var(--bg-body);">
                <div class="progress-bar bg-${color}" role="progressbar" style="width:${pct}%"></div>
              </div>
            </div>
          `;
        });
      }

      // Chart (bar)
      if(msiChartInstance) msiChartInstance.destroy();

      if(items.length === 0){
        canvas.style.display='none';
        noData.classList.remove('d-none');
        return;
      }else{
        canvas.style.display='block';
        noData.classList.add('d-none');
      }

      const isDark = isDarkMode();
      const textColor=isDark ? '#f9fafb' : '#6b7280';

      const labels = items.slice(0, 10).map(t => {
        const name = (t.concept || 'MSI').trim();
        return name.length > 16 ? name.slice(0, 16) + '‚Ä¶' : name;
      });
      const values = items.slice(0, 10).map(t => t.remaining);

      msiChartInstance = new Chart(canvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Meses restantes',
            data: values
          }]
        },
        options: {
          indexAxis: 'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{ display:false },
            tooltip:{ enabled:true }
          },
          scales: {
            x: {
              beginAtZero:true,
              ticks: { color:textColor }
            },
            y: {
              ticks: { color:textColor, precision:0 }
            }
          }
        }
      });

      if(privacy) togglePrivacy();
    };

    // =========================
    // ‚úÖ HISTORIAL
    // =========================
    const REVIEWED_KEY = "fy_reviewed_ids";
    let reviewedIds = new Set();

    const loadReviewedIds = () => {
      try{
        const raw = JSON.parse(localStorage.getItem(REVIEWED_KEY) || "[]");
        reviewedIds = new Set(Array.isArray(raw) ? raw : []);
      }catch(e){
        reviewedIds = new Set();
      }
    };

    const saveReviewedIds = () => {
      localStorage.setItem(REVIEWED_KEY, JSON.stringify(Array.from(reviewedIds)));
    };

    const isTransactionReviewed = (id) => reviewedIds.has(id);

    const markTransactionReviewed = (id) => {
      if(!id) return;
      reviewedIds.add(id);
      saveReviewedIds();
      const item = document.querySelector(`.swipe-item[data-trans-id="${id}"]`);
      if(item) item.classList.add("reviewed");
      showToast("Marcado como revisado ‚úÖ", { tone: "success", duration: 1800 });
    };

    const renderTimeline = (grouped = []) => grouped.map((group) => `
      <div class="timeline-day">
        <div class="timeline-header">
          <div class="timeline-title">${group.label}</div>
          <div class="timeline-subtotal">
            Subtotal: <span class="sensitive-data">${formatCurrency(group.subtotal)}</span>
          </div>
        </div>
        <div class="timeline-items">
          ${group.items.map((t) => {
            const isExp = t.type === "expense";
            const tagMsi = (isExp && t.isMsi) ? `<span class="badge-status bg-success-light ms-2">MSI</span>` : "";
            const d = toDate(t.date);
            const reviewedClass = isTransactionReviewed(t.id) ? "reviewed" : "";
            return `
              <div class="list-item swipe-item ${reviewedClass}" data-trans-id="${t.id}">
                <div class="d-flex align-items-center">
                  <div class="me-3 text-muted"><i class="fas ${isExp ? "fa-shopping-cart" : "fa-hand-holding-usd"}"></i></div>
                  <div>
                    <div class="fw-bold">${t.concept}${tagMsi}</div>
                    <small class="text-muted">${d.toLocaleDateString()} ‚Ä¢ ${t.cardName} ‚Ä¢ ${t.category}</small>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <div class="fw-bold ${isExp ? "text-danger" : "text-success"} sensitive-data">${isExp ? "-" : "+"}${formatMoney(t.amount)}</div>
                  <div class="item-actions">
                    <button class="action-kebab" type="button" onclick="toggleTransMenu('${t.id}', event)" aria-label="Acciones">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="action-menu" id="trans-menu-${t.id}">
                      <button type="button" onclick="handleTransAction('edit','${t.id}', event)">Editar</button>
                      <button type="button" onclick="handleTransAction('review','${t.id}', event)">Revisado</button>
                      <button type="button" onclick="handleTransAction('delete','${t.id}', event)" class="text-danger">Borrar</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `).join("");

    window.renderHistory = () => {
      const list = document.getElementById('hist-list');
      const term = (document.getElementById('search-input')?.value || "").toLowerCase();

      const dateFilter = document.getElementById('hist-month-filter')?.value || "all";
      const cardFilter = document.getElementById('hist-card-filter')?.value || "all";
      const catFilter  = document.getElementById('hist-cat-filter')?.value || "all";

      if(!list) return;
      list.innerHTML = '';

      const scopedTrans = FEATURES.coupleMode ? applyScopeFilter(trans, getActiveScopeFilter()) : trans;
      const filtered = scopedTrans.filter(t => {
        const matchesText =
          (t.concept || "").toLowerCase().includes(term) ||
          (t.cardName || "").toLowerCase().includes(term) ||
          (t.category || "").toLowerCase().includes(term);

        let matchesDate = true;
        if (dateFilter !== 'all') {
          const [y, m] = dateFilter.split('-').map(Number);
          const d = toDate(t.date);
          matchesDate = (d.getMonth() === m && d.getFullYear() === y);
        }

        let matchesCard = true;
        if (cardFilter !== 'all') matchesCard = (t.cardId === cardFilter);

        let matchesCat = true;
        if (catFilter !== 'all') matchesCat = (t.category === catFilter);

        return matchesText && matchesDate && matchesCard && matchesCat;
      });

      if (filtered.length === 0) {
        list.innerHTML = '<div class="text-center text-muted mt-3">No se encontraron resultados</div>';
        return;
      }

      const grouped = groupExpensesByDay(filtered);
      list.innerHTML = renderTimeline(grouped);
      setupHistoryInteractions();

      if (privacy) togglePrivacy();
    };

    const closeAllTransMenus = () => {
      document.querySelectorAll(".action-menu.is-open").forEach((menu) => {
        menu.classList.remove("is-open");
      });
    };

    window.toggleTransMenu = (id, event) => {
      event?.stopPropagation();
      const menu = document.getElementById(`trans-menu-${id}`);
      if(!menu) return;
      const isOpen = menu.classList.contains("is-open");
      closeAllTransMenus();
      if(!isOpen) menu.classList.add("is-open");
    };

    window.handleTransAction = (action, id, event) => {
      event?.stopPropagation();
      closeAllTransMenus();
      if(action === "edit") return editTrans(id);
      if(action === "review") return markTransactionReviewed(id);
      if(action === "delete"){
        document.getElementById('trans-id').value = id;
        return deleteTrans();
      }
    };

    document.addEventListener("click", (event) => {
      if(event.target.closest(".item-actions")) return;
      closeAllTransMenus();
    });

    const setupHistoryInteractions = () => {
      const items = document.querySelectorAll(".swipe-item");
      items.forEach((item) => {
        if(item.dataset.swipeBound === "1") return;
        item.dataset.swipeBound = "1";

        item.addEventListener("click", (event) => {
          if(item.dataset.swipeMoved === "1") return;
          if(event.target.closest(".item-actions")) return;
          const id = item.dataset.transId;
          if(id) editTrans(id);
        });

        item.addEventListener("pointerdown", (event) => {
          if(event.target.closest(".item-actions")) return;
          if(event.pointerType === "mouse") return;
          const startX = event.clientX;
          const startY = event.clientY;
          let dx = 0;
          let dy = 0;
          let swiping = false;
          item.dataset.swipeMoved = "0";
          item.setPointerCapture(event.pointerId);

          const onMove = (moveEvent) => {
            dx = moveEvent.clientX - startX;
            dy = moveEvent.clientY - startY;
            if(!swiping){
              if(Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)){
                swiping = true;
                item.classList.add("dragging");
              }else if(Math.abs(dy) > 10){
                cleanup();
                return;
              }
            }
            if(swiping){
              moveEvent.preventDefault();
              const clamped = Math.max(Math.min(dx, 90), -90);
              item.style.transform = `translateX(${clamped}px)`;
              item.dataset.swipeMoved = "1";
            }
          };

          const onEnd = () => {
            item.classList.remove("dragging");
            item.style.transform = "";
            if(swiping && Math.abs(dx) >= 60 && Math.abs(dx) > Math.abs(dy)){
              const id = item.dataset.transId;
              if(dx > 0) markTransactionReviewed(id);
              else editTrans(id);
            }
            cleanup();
          };

          const cleanup = () => {
            item.releasePointerCapture(event.pointerId);
            item.removeEventListener("pointermove", onMove);
            item.removeEventListener("pointerup", onEnd);
            item.removeEventListener("pointercancel", onEnd);
          };

          item.addEventListener("pointermove", onMove);
          item.addEventListener("pointerup", onEnd);
          item.addEventListener("pointercancel", onEnd);
        });
      });
    };

    // =========================
    // ‚úÖ CHART GASTOS
    // =========================
    const categoryAggCache = new Map();
    const chartRenderState = { scheduled: false };

    const getCategoryAggCacheKey = ({ owner, periodKey, scopeFilter }) =>
      `${owner}|${periodKey}|${scopeFilter}`;

    const getPeriodKeyFromDate = (dateValue) => {
      const d = dateValue instanceof Date ? dateValue : new Date(dateValue);
      return `${d.getFullYear()}-${d.getMonth()}`;
    };

    const invalidateCategoryAggCacheForOwner = (owner) => {
      const prefix = `${owner}|`;
      Array.from(categoryAggCache.keys()).forEach((key) => {
        if (key.startsWith(prefix)) categoryAggCache.delete(key);
      });
    };

    const invalidateCategoryAggCacheForPeriod = (owner, periodKey) => {
      const prefix = `${owner}|${periodKey}|`;
      Array.from(categoryAggCache.keys()).forEach((key) => {
        if (key.startsWith(prefix)) categoryAggCache.delete(key);
      });
    };

    const setChartUiState = ({ showCanvas, showSkeleton, showNoData, showError }) => {
      const canvas = document.getElementById("expensesChart");
      const noDataMsg = document.getElementById("no-data-msg");
      const skeleton = document.getElementById("chart-skeleton");
      const errorMsg = document.getElementById("chart-error-msg");
      if (canvas) canvas.style.display = showCanvas ? "block" : "none";
      if (noDataMsg) noDataMsg.classList.toggle("d-none", !showNoData);
      if (skeleton) skeleton.classList.toggle("d-none", !showSkeleton);
      if (errorMsg) errorMsg.classList.toggle("d-none", !showError);
    };

    const computeCategoryAgg = (items, selYear, selMonth) => {
      const totals = new Map();
      let expensesCount = 0;
      items.forEach((t) => {
        if (t.type !== "expense") return;
        const rawDate = t.date?.toDate ? t.date.toDate() : t.date;
        if (!rawDate) return;
        const d = rawDate instanceof Date ? rawDate : new Date(rawDate);
        if (d.getMonth() !== selMonth || d.getFullYear() !== selYear) return;
        expensesCount += 1;
        const category = (t.category || "Sin categor√≠a").trim() || "Sin categor√≠a";
        totals.set(category, (totals.get(category) || 0) + t.amount);
      });

      const sorted = Array.from(totals.entries()).sort((a, b) => b[1] - a[1]);
      const top = sorted.slice(0, 6);
      const others = sorted.slice(6).reduce((sum, [, amount]) => sum + amount, 0);
      if (others > 0) top.push(["Otros", others]);

      return {
        labels: top.map(([label]) => label),
        data: top.map(([, amount]) => amount),
        expensesCount,
        categoryCount: top.length
      };
    };

    const computeCategoryAggAsync = (items, selYear, selMonth) => {
      const shouldDefer = items.length > 1500;
      if (shouldDefer && typeof requestIdleCallback === "function") {
        return new Promise((resolve) => {
          requestIdleCallback(() => resolve(computeCategoryAgg(items, selYear, selMonth)), { timeout: 200 });
        });
      }
      if (shouldDefer) {
        return new Promise((resolve) => {
          setTimeout(() => resolve(computeCategoryAgg(items, selYear, selMonth)), 0);
        });
      }
      return Promise.resolve(computeCategoryAgg(items, selYear, selMonth));
    };

    const attemptChartRender = async ({ attempt = 0 } = {}) => {
      const container = document.getElementById("chart-container");
      const canvas = document.getElementById("expensesChart");
      if (!container || !canvas) return;

      if (dataState.loading) {
        setChartUiState({ showCanvas: false, showSkeleton: true, showNoData: false, showError: false });
        return;
      }

      if (!trans.length) {
        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
        setChartUiState({ showCanvas: false, showSkeleton: false, showNoData: true, showError: false });
        return;
      }

      const rect = container.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      if (width < 50 || height < 50) {
        setChartUiState({ showCanvas: false, showSkeleton: true, showNoData: false, showError: false });
        if (attempt < 5) {
          setTimeout(() => attemptChartRender({ attempt: attempt + 1 }), 0);
        } else {
          if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
          }
          setChartUiState({ showCanvas: false, showSkeleton: false, showNoData: false, showError: true });
        }
        return;
      }

      const filterEl = document.getElementById("chart-month-filter");
      if (!filterEl || !filterEl.value) return;
      const filterVal = filterEl.value;
      const [selYear, selMonth] = filterVal.split("-").map(Number);
      const scopeFilter = getActiveScopeFilter();
      const owner = getActiveOwner();
      const periodKey = `${selYear}-${selMonth}`;
      const cacheKey = getCategoryAggCacheKey({ owner, periodKey, scopeFilter });
      const startCompute = performance.now();
      let cached = true;
      let agg = categoryAggCache.get(cacheKey);

      try {
        if (!agg) {
          cached = false;
          setChartUiState({ showCanvas: false, showSkeleton: true, showNoData: false, showError: false });
          const scopedTrans = applyScopeFilter(trans, scopeFilter);
          agg = await computeCategoryAggAsync(scopedTrans, selYear, selMonth);
          categoryAggCache.set(cacheKey, agg);
        }

        const computeMs = cached ? 0 : performance.now() - startCompute;
        console.info("[chart:pie]", {
          expensesCount: agg.expensesCount,
          categoryCount: agg.categoryCount,
          width: Math.round(width),
          height: Math.round(height),
          computeMs: Math.round(computeMs),
          cached
        });

        if (!agg.labels.length) {
          if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
          }
          setChartUiState({ showCanvas: false, showSkeleton: false, showNoData: true, showError: false });
          return;
        }

        if (chartInstance) chartInstance.destroy();

        const isDark = isDarkMode();
        const textColor = isDark ? "#f9fafb" : "#6b7280";

        chartInstance = new Chart(canvas, {
          type: "doughnut",
          data: {
            labels: agg.labels,
            datasets: [{
              data: agg.data,
              backgroundColor: ["#2563eb", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899", "#6366f1"],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: "right", labels: { boxWidth: 10, font: { size: 10 }, color: textColor } } }
          }
        });

        setChartUiState({ showCanvas: true, showSkeleton: false, showNoData: false, showError: false });
      } catch (err) {
        console.error("[chart:pie] render error", err);
        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
        setChartUiState({ showCanvas: false, showSkeleton: false, showNoData: false, showError: true });
      }
    };

    const scheduleChartRender = () => {
      if (chartRenderState.scheduled) return;
      chartRenderState.scheduled = true;
      requestAnimationFrame(() => {
        chartRenderState.scheduled = false;
        attemptChartRender({ attempt: 0 });
      });
    };

    window.updateChart = () => {
      scheduleChartRender();
    };

    // =========================
    // ‚úÖ CATEGOR√çAS
    // =========================
    window.uiUpdateCats=()=>{
      const type=document.querySelector('input[name="ttype"]:checked').value;
      const s=document.getElementById('t-cat');
      s.innerHTML='';
      const opts = type==='expense'
        ? ['üõí Supermercado','üçî Comida','‚õΩ Transporte','üêú Hormiga','üí° Servicios','üì¶ Compras','üíä Salud','üéì Educaci√≥n','üë©‚Äçü¶∞ Mam√°']
        : ['üíµ Abono Capital','üí∞ Sueldo/Ingreso','üîÑ Transferencia'];
      opts.forEach(o=> s.innerHTML += `<option>${o}</option>`);
      if(typeof syncQuickCategories === "function") syncQuickCategories();
    };

    // =========================
    // ‚úÖ UI MSI
    // =========================
    window.uiToggleMsi = () => {
      const type=document.querySelector('input[name="ttype"]:checked').value;
      const box = document.getElementById('msi-box');
      if(type === 'expense'){
        box.style.display = 'block';
      }else{
        box.style.display = 'none';
        document.getElementById('t-msi').checked = false;
        uiToggleMsiFields();
      }
      uiCalcMsiMonthly();
    };

    window.uiToggleScope = () => {
      const type=document.querySelector('input[name="ttype"]:checked').value;
      const scopeField = document.getElementById('scope-field');
      if(!scopeField) return;
      if(type === 'expense'){
        scopeField.style.display = 'block';
      }else{
        scopeField.style.display = 'none';
        document.getElementById('t-scope-shared').checked = true;
      }
    };

    window.uiToggleMsiFields = () => {
      const on = document.getElementById('t-msi').checked;
      const fields = document.getElementById('msi-fields');
      fields.style.display = on ? 'block' : 'none';

      // si prenden MSI y no hay start, lo ponemos igual a fecha transacci√≥n
      if(on){
        const d = document.getElementById('t-date').value;
        if(d) document.getElementById('t-msi-start').value = d;
      }
      uiCalcMsiMonthly();
    };

    function uiCalcMsiMonthly(){
      const on = document.getElementById('t-msi').checked;
      const monthlyEl = document.getElementById('msi-monthly');
      if(!on){ monthlyEl.textContent = formatMoney(0); return; }
      const amt = parseFloat(document.getElementById('t-amount').value || 0);
      const months = parseInt(document.getElementById('t-msi-months').value || 1);
      const monthly = months > 0 ? (amt / months) : 0;
      monthlyEl.textContent = formatMoney(monthly);
    }

    document.getElementById('t-amount').addEventListener('input', uiCalcMsiMonthly);
    document.getElementById('t-msi-months').addEventListener('change', uiCalcMsiMonthly);
    document.getElementById('t-date').addEventListener('change', ()=>{
      const on = document.getElementById('t-msi').checked;
      if(on) document.getElementById('t-msi-start').value = document.getElementById('t-date').value;
    });

    // =========================
    // Helpers plain
    // =========================
    function txToPlain(t){
      return {
        id: t.id,
        owner: t.owner,
        type: t.type,
        amount: t.amount,
        cardId: t.cardId,
        cardName: t.cardName,
        concept: t.concept,
        category: t.category,
        scope: t.scope || null,
        isMsi: !!t.isMsi,
        msiMonths: t.msiMonths || null,
        msiStartISO: (t.msiStart?.toDate ? t.msiStart.toDate().toISOString() : null),
        dateISO: (t.date?.toDate ? t.date.toDate().toISOString() : null)
      };
    }
    function cardToPlain(c){
      return {
        id: c.id,
        owner: c.owner,
        name: c.name,
        cutDay: Number(c.cutDay||1),
        payDay: Number(c.payDay||1),
        limit: Number(c.limit||0),
        balance: Number(c.balance||0),
        payGoal: Number(c.payGoal||0)
      };
    }

    // Tarjetas (editar)
    window.openCardModal=()=> {
      showToast("Tip: para editar, toca una tarjeta en la lista y se abrir√° el editor üòâ", {
        tone: "info",
        duration: 2600
      });
    };

    // Metas
    window.openGoalModal = () => {
      const nameInput = document.getElementById('goal-name');
      const targetInput = document.getElementById('goal-target');
      const priorityInput = document.getElementById('goal-priority');
      if(nameInput) nameInput.value = '';
      if(targetInput) targetInput.value = '';
      if(priorityInput) priorityInput.value = '';
      goalModal = new bootstrap.Modal(document.getElementById('modalGoal'));
      goalModal.show();
    };

    const goalDetailEl = document.getElementById('modalGoalDetail');
    if(goalDetailEl){
      goalDetailEl.addEventListener('hidden.bs.modal', ()=>{
        activeGoalDetailId = null;
      });
    }

    window.editCard=(id)=>{
      const c=cards.find(x=>x.id===id); if(!c) return;
      document.getElementById('c-id').value=id;
      document.getElementById('c-name').value=c.name;
      document.getElementById('c-cut').value=c.cutDay;
      document.getElementById('c-pay').value=c.payDay;
      document.getElementById('c-limit').value=c.limit;
      document.getElementById('c-bal').value=c.balance;
      document.getElementById('c-goal').value=c.payGoal||0;
      document.getElementById('btn-del-card').style.display = (c.owner==="both") ? "none" : "block";
      cardModal = new bootstrap.Modal(document.getElementById('modalCard'));
      cardModal.show();
    };

    document.getElementById('form-card').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const id=document.getElementById('c-id').value; if(!id) return;

      const payload={
        name: document.getElementById('c-name').value,
        cutDay: parseInt(document.getElementById('c-cut').value||1),
        payDay: parseInt(document.getElementById('c-pay').value||1),
        limit: parseFloat(document.getElementById('c-limit').value||0),
        balance: parseFloat(document.getElementById('c-bal').value||0),
        payGoal: parseFloat(document.getElementById('c-goal').value||0)
      };

      await updateDoc(doc(db,"cards",id), payload);
      cardModal.hide();

      const updated = cards.find(x=>x.id===id);
      await sheetsSend({
        entity: "card",
        action: "update",
        owner: OWNER,
        data: cardToPlain({ ...(updated||{}), ...payload, id })
      });
    });

    document.getElementById('form-goal').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const name = document.getElementById('goal-name').value.trim();
      const targetAmount = parseFloat(document.getElementById('goal-target').value || 0);
      const priorityRaw = document.getElementById('goal-priority').value;
      const priority = priorityRaw === "" ? null : Number(priorityRaw);
      if(!name || !Number.isFinite(targetAmount)){
        showToast("Completa el nombre y el monto objetivo.", { tone: "warning", duration: 2400 });
        return;
      }

      const samePriority = goals.filter(g=>getGoalPriorityValue(g.priority) === getGoalPriorityValue(priority));
      const maxSort = samePriority.length
        ? Math.max(...samePriority.map(g=>Number.isFinite(g.sortOrder) ? g.sortOrder : 0))
        : -GOAL_SORT_STEP;
      const nextSortOrder = maxSort + GOAL_SORT_STEP;

      try{
        await addDoc(collection(db,"goals"), {
          name,
          targetAmount,
          status: "active",
          priority,
          sortOrder: nextSortOrder,
          savedAmount: 0,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        if(goalModal) goalModal.hide();
        showToast("Meta creada", { tone: "success", duration: 2000 });
      }catch(err){
        console.error("Create goal error:", err);
        showToast("No se pudo crear la meta.", { tone: "warning", duration: 2400 });
      }
    });

    document.getElementById('form-goal-contribution').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const goalId = document.getElementById('goal-contribution-id').value;
      const amount = parseFloat(document.getElementById('goal-contribution-amount').value || 0);
      const owner = document.getElementById('goal-contribution-owner').value || OWNER;
      const noteRaw = document.getElementById('goal-contribution-note').value.trim();
      const dateValue = document.getElementById('goal-contribution-date').value;
      if(!goalId || !Number.isFinite(amount) || amount <= 0){
        showToast("Ingresa un monto v√°lido.", { tone: "warning", duration: 2200 });
        return;
      }
      const date = dateValue ? (parseLocalYYYYMMDDToDate(dateValue) || new Date()) : new Date();
      try{
        await addDoc(collection(db,"goal_contributions"), {
          goalId,
          amount,
          owner,
          note: noteRaw || null,
          date: Timestamp.fromDate(date),
          createdAt: serverTimestamp()
        });
        await updateDoc(doc(db,"goals", goalId), {
          savedAmount: increment(amount),
          updatedAt: serverTimestamp()
        });
        const goal = goals.find(g=>g.id===goalId);
        if(goal){
          goal.savedAmount = Number(goal.savedAmount || 0) + amount;
        }
        renderGoals();
        if(activeGoalDetailId === goalId){
          renderGoalDetail(goalId);
        }
        if(goalContributionModal) goalContributionModal.hide();
        showToast("Aportaci√≥n guardada.", { tone: "success", duration: 2000 });
      }catch(err){
        console.error("Save goal contribution error:", err);
        showToast("No se pudo guardar la aportaci√≥n.", { tone: "warning", duration: 2400 });
      }
    });

    window.deleteCard=async()=>{
      const id=document.getElementById('c-id').value;
      const c=cards.find(x=>x.id===id);
      if(!c) return;
      if(c.owner==="both"){
        showToast("Esa tarjeta es compartida. Mejor ed√≠tala üòâ", { tone: "info", duration: 2400 });
        return;
      }
      if(confirm("¬øEliminar tarjeta?")){
        await deleteDoc(doc(db,"cards",id));
        cardModal.hide();

        await sheetsSend({
          entity: "card",
          action: "delete",
          owner: OWNER,
          data: { id }
        });
      }
    };

    // =========================
    // ‚úÖ MOVIMIENTOS (con MSI)
    // =========================
    document.getElementById('form-trans').addEventListener('submit', async(e)=>{
      e.preventDefault();
      const btnSave=document.getElementById('btn-save-trans');
      let saveSuccess = false;

      const type=document.querySelector('input[name="ttype"]:checked')?.value;
      const amt=parseFloat(document.getElementById('t-amount').value);
      const cid=document.getElementById('t-card').value;
      const dateValue = document.getElementById('t-date').value;
      if(!type || !cid || !dateValue || !Number.isFinite(amt) || amt <= 0){
        showToast("Completa los datos requeridos para guardar.", { tone: "warning", duration: 2400 });
        haptic("error");
        return;
      }

      setLoading(btnSave, true, { label: "Guardando..." });

      try{
        const tid=document.getElementById('trans-id').value;
        const cObj=cards.find(c=>c.id===cid);
        if(!cObj) throw new Error("Tarjeta no encontrada");
        const previousTrans = tid ? trans.find(t=>t.id===tid) : null;

        let newBal=parseFloat(cObj.balance||0);
        const batch=writeBatch(db);

        // Reversi√≥n si es edici√≥n
        if(tid){
          if(previousTrans && previousTrans.cardId===cid){
            if(previousTrans.type==='expense') newBal -= previousTrans.amount;
            else newBal += previousTrans.amount;
          }
        }
        if(type==='expense') newBal += amt;
        else newBal -= amt;

        // MSI payload
        const isMsi = (type === 'expense') && document.getElementById('t-msi').checked;
        const msiMonths = isMsi ? parseInt(document.getElementById('t-msi-months').value || 0) : null;
        const msiStartStr = isMsi ? (document.getElementById('t-msi-start').value || document.getElementById('t-date').value) : null;
        const msiStartDate = isMsi && msiStartStr ? parseLocalYYYYMMDDToDate(msiStartStr) : null;
        const msiStart = msiStartDate ? Timestamp.fromDate(msiStartDate) : null;

        const scopeValue = type === "expense"
          ? normalizeScope(document.querySelector('input[name="tscope"]:checked')?.value)
          : null;

        const payload = {
          owner: OWNER,
          amount: amt,
          type,
          cardId: cid,
          cardName: cObj.name,
          concept: document.getElementById('t-concept').value,
          category: document.getElementById('t-cat').value,
          date: Timestamp.fromDate(parseLocalYYYYMMDDToDate(document.getElementById('t-date').value) || new Date()),
          scope: scopeValue,

          // MSI
          isMsi: !!isMsi,
          msiMonths: msiMonths,
          msiStart: msiStart
        };

        const cardRef=doc(db,"cards",cid);

        if(tid){
          batch.update(doc(db,"expenses",tid), payload);
          batch.update(cardRef, { balance:newBal });
          await batch.commit();

          await sheetsSend({
            entity: "transaction",
            action: "update",
            owner: OWNER,
            data: txToPlain({ ...payload, id: tid })
          });
          emit("EXPENSE_UPDATED", { id: tid, data: payload });

        }else{
          const createdRef = await addDoc(collection(db,"expenses"), payload);
          await updateDoc(cardRef, { balance:newBal });

          await sheetsSend({
            entity: "transaction",
            action: "create",
            owner: OWNER,
            data: txToPlain({ ...payload, id: createdRef.id })
          });
          emit("EXPENSE_ADDED", { id: createdRef.id, data: payload });
        }

        if(previousTrans?.type === "expense" && previousTrans?.date){
          const prevDate = previousTrans.date?.toDate ? previousTrans.date.toDate() : previousTrans.date;
          invalidateCategoryAggCacheForPeriod(OWNER, getPeriodKeyFromDate(prevDate));
        }
        if(type === "expense" && dateValue){
          const cacheDate = parseLocalYYYYMMDDToDate(dateValue);
          if(cacheDate){
            invalidateCategoryAggCacheForPeriod(OWNER, getPeriodKeyFromDate(cacheDate));
          }
        }

        if(!navigator.onLine){
          showToast("Guardado (offline). Se sincroniza al reconectar.", { tone: "warning", duration: 3600 });
          setSyncStatus("local", { silent: true });
        }else{
          showToast("Guardado", { tone: "success", duration: 2000 });
        }
        haptic("success");
        saveSuccess = true;
        if(quickAddPending){
          quickAddPending = false;
          closeQuickAdd();
        }

        invalidateCacheForOwner(OWNER);
        refreshAll({ owner: OWNER, force: true, source: "save-expense" });
        updateAlerts({ force: true });
        cancelSimulation();
        resetForm();
        nav('view-home');
      }catch(e){
        showToast("No se pudo guardar. Intenta de nuevo.", { tone: "warning", duration: 2600 });
        haptic("error");
      }finally{
        if(!saveSuccess) quickAddPending = false;
        setLoading(btnSave, false);
        if(saveSuccess) flashButtonSuccess(btnSave);
      }
    });

    window.editTrans=(id)=>{
      const t=trans.find(x=>x.id===id); if(!t) return;
      nav('view-add');

      document.getElementById('trans-id').value=id;
      document.getElementById('t-amount').value=t.amount;
      document.getElementById('t-card').value=t.cardId;
      document.getElementById('t-concept').value=t.concept;
      const transDate = t.date?.toDate ? t.date.toDate() : t.date;
      document.getElementById('t-date').value = toLocalYYYYMMDD(transDate);

      if(t.type==='payment') document.getElementById('t-pay').checked=true;
      else document.getElementById('t-exp').checked=true;

      uiUpdateCats();
      document.getElementById('t-cat').value=t.category;
      uiToggleScope();
      const scopeValue = normalizeScope(t.scope);
      if(scopeValue === "personal"){
        document.getElementById('t-scope-personal').checked = true;
      }else{
        document.getElementById('t-scope-shared').checked = true;
      }

      // MSI
      uiToggleMsi();
      const isMsi = !!t.isMsi;
      document.getElementById('t-msi').checked = isMsi;

      uiToggleMsiFields();
      if(isMsi){
        document.getElementById('t-msi-months').value = String(t.msiMonths || 6);
        const s = t.msiStart?.toDate ? t.msiStart.toDate() : null;
        document.getElementById('t-msi-start').value = s ? toLocalYYYYMMDD(s) : document.getElementById('t-date').value;
      }

      uiCalcMsiMonthly();

      document.getElementById('edit-btns').style.display='flex';
    };

    window.deleteTrans=async()=>{
      if(!confirm("¬øEliminar? Se recalcular√° el saldo.")) return;

      const id=document.getElementById('trans-id').value;
      const t=trans.find(x=>x.id===id);
      if(!t) return;

      const cObj=cards.find(c=>c.id===t.cardId);
      if(!cObj){
        showToast("Tarjeta no encontrada para recalcular saldo.", { tone: "warning", duration: 2400 });
        return;
      }

      let newBal=parseFloat(cObj.balance||0);
      if(t.type==='expense') newBal -= t.amount;
      else newBal += t.amount;

      const batch=writeBatch(db);
      batch.update(doc(db,"cards",t.cardId), { balance:newBal });
      batch.delete(doc(db,"expenses",id));
      await batch.commit();

      await sheetsSend({
        entity: "transaction",
        action: "delete",
        owner: OWNER,
        data: { id }
      });
      emit("EXPENSE_DELETED", { id });
      if(t.type === "expense" && t.date){
        const prevDate = t.date?.toDate ? t.date.toDate() : t.date;
        invalidateCategoryAggCacheForPeriod(OWNER, getPeriodKeyFromDate(prevDate));
      }

      invalidateCacheForOwner(OWNER);
      refreshAll({ owner: OWNER, force: true, source: "delete-expense" });
      updateAlerts({ force: true });
      cancelSimulation();
      resetForm();
      nav('view-hist');
    };

    window.resetForm=()=>{
      document.getElementById('form-trans').reset();
      document.getElementById('trans-id').value='';
      document.getElementById('t-date').value = toLocalYYYYMMDD(new Date());
      document.getElementById('edit-btns').style.display='none';
      document.getElementById('t-exp').checked=true;

      // MSI defaults
      uiUpdateCats();
      uiToggleMsi();
      uiToggleScope();
      document.getElementById('t-scope-shared').checked = true;
      document.getElementById('t-msi').checked=false;
      document.getElementById('t-msi-months').value="6";
      document.getElementById('t-msi-start').value = document.getElementById('t-date').value;
      uiToggleMsiFields();
      uiCalcMsiMonthly();

      const btn=document.getElementById('btn-save-trans');
      setLoading(btn, false);
    };

    window.exportCSV=()=>{
      let csv="Fecha,Concepto,Categoria,Monto,Tipo,Tarjeta,Owner,Scope,MSI,MSI_Meses,MSI_Inicio\n";
      trans.forEach(t=>{
        const msi = t.isMsi ? "SI" : "NO";
        const msiMonths = t.msiMonths || "";
        const msiStart = t.msiStart?.toDate ? t.msiStart.toDate().toLocaleDateString() : "";
        const scope = t.scope ? t.scope : "";
        csv += `${t.date.toDate().toLocaleDateString()},${(t.concept||"").replaceAll(","," ")},${(t.category||"").replaceAll(","," ")},${t.amount},${t.type},${(t.cardName||"").replaceAll(","," ")},${t.owner},${scope},${msi},${msiMonths},${msiStart}\n`;
      });
      const a=document.createElement('a');
      a.href='data:text/csv;charset=utf-8,'+encodeURI(csv);
      a.download=`backup_finanzas_${OWNER}.csv`;
      a.click();
    };

    on("DATA_LOADED", () => {
      invalidateCategoryAggCacheForOwner(OWNER);
      refreshAll({ owner: OWNER, force: true, source: "snapshot" });
      updateAlerts({ force: true });
      updateMonthlyFootprint({ force: true });
      if(FEATURES.timeline){
        renderHistory();
      }
      updateChart();
      updatePaymentMonitor();
      renderMsi();
    });

    on("FILTER_CHANGED", () => {
      invalidateCategoryAggCacheForOwner(OWNER);
      refreshAll({ owner: OWNER, force: true, source: "filter-change" });
      updateAlerts({ force: true });
      updateMonthlyFootprint({ force: true });
      if(FEATURES.timeline){
        renderHistory();
      }
      updateChart();
    });

    // Init
    loadReviewedIds();
    initThemeMode();
    uiUpdateCats();
    resetForm();
    uiToggleScope();
    applyFeatureVisibility();
    syncScopeFilterUI();
    setupGoalEvents();
    document.body.classList.toggle('ios-fallback', isProbablyIOS() || !window.PointerEvent);
    startLoader();
    await seedPresetCards();
    resubscribeAll();
  </script>
</body>
</html>
